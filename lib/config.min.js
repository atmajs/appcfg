/*!
 * config v0.1.28
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
!function(n,e){"use strict";function t(){return e(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=n||i,"function"==typeof define&&define.amd?define(t):(t(),void("undefined"!=typeof module&&(module.exports=r.Config)))}(this,function(n,e){"use strict";var t,r,i;!function(){var e=n;null==e.Class&&n.atma&&(e=n.atma),null==e.Class&&(e=require("atma-libs/exports")),i=e.Class,r=e.net,t=n.io||require("atma-io")}();var o,a;!function(){o=function(n){return null!=n&&"number"==typeof n.length&&"function"==typeof n.splice},a=function(n){return null!=n&&"object"==typeof n}}();var u;!function(){var n;u=function(){if(null!=n)return n;for(var e,t,r,i=process.argv,o=i.length,a=2,u={},l=[];o>a;a++)r=i[a],"-"!==r[0]?l.push(r):(e=r.replace(/^[\-]+/,""),o-1>a&&"-"!==i[a+1][0]?(t=i[a+1],a++):t=!0,u[e]=t);return n={params:u,args:l}}}();var l,f,c,s,d,g,h;!function(){l=function(n,e){for(var t=e.split("."),r=t.length,i=-1;++i<r;){if(null==n)return null;n=n[t[i]]}return n},f=function(n,e,t){for(var r,i=e.split("."),o=i.length,a=-1;++a<o-1;)r=i[a],null==n[r]&&(n[r]={}),n=n[r];n[i[a]]=t},c=function(n,e){for(var t in e)null==n[t]&&(n[t]=e[t]);return n},s=function(n,e){for(var t in e)null!=e[t]&&(n[t]=e[t]);return n},d=function(n,e){if(null==n&&(n={}),null==e)return n;if(o(n)&&o(e)){for(var t,r=0,i=e.length;i>r;r++)t=e[r],null!=t&&n.push(a(t)?d({},t):t);return n}if(!a(e)&&!a(n))return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),n;var u,l;for(u in e)if(l=e[u],33!==u.charCodeAt(0)){if(null!=l)if(null!=n[u])if(o(l)){if(o(n[u])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",u,l,n[u]),n[u]=l;continue}d(n[u],l)}else n[u]=a(l)&&a(n[u])?d(n[u],l):l;else n[u]=l}else n[u.substring(1)]=l;return n},g=function(n,e,t){var r=l(n,e);return null==r?f(n,e,null==t?{}:t):void(typeof r!=typeof t&&logger.error("<obj_ensureProperty> type missmatch",typeof r,typeof t,(new Error).stack))},h=function(n,e){if(null!=n)if(null==e&&(e=n),o(n))for(var t=n.length;--t>-1;)h(n[t],e);else if(a(n)){var r,i;for(r in n)if(i=n[r],null!=i&&"_"!==r[0])if(a(i))h(i,e);else if("string"==typeof i){var u=i.trim();if("#["!==u.substring(0,2))continue;if(u=u.substring(2,u.length-1).trim(),n[r]=l(e,u),null==n[r]){console.warn("<config: obj_interpolate: property not exists in root",i);continue}}}}}();var p,v;!function(){function n(n){var e=process.env,r=e[n];if(null!=r)return r;switch(n){case"TEMP":r=e.TMP||e.TMPDIR;break;case"APP":r=t.env.applicationDir.toLocalDir();break;case"APPDATA":r=e.HOME}return null==r&&logger.error("<config:special-folder> Not resolved",n),v(r||e.HOME||n)}var e=/^%(\w+)%/,r=/[\/]{2,}/g,i={};p=function(t){return e.test(t)===!1?t:(t=v(t).replace(e,function(e,t){return t=t.toUpperCase(),null!=i[t]?i[t]:i[t]=n(t)}).replace(r,"/"),"file://"+t)},v=function(n){return n.replace(/\\/g,"/")}}();var w;!function(){w=function(n,e){if(null!=e.config){var t=e.data.setterProperty;t&&(g(config,t,{}),n=l(config,t)),d(n,e.config)}}}();var y;!function(){function n(n){o(n)&&t(n),a(n)&&e(n)}function e(e){var t,o,l;for(t in e)l=t.charCodeAt(0),36!==l&&(o=e[t],a(o)!==!1&&(r(t)?u(t)&&d(e,o):i(o)?e[t]=c(o):n(o)))}function t(e){for(var t,r,u=e.length,l=-1;++l<u;)if(t=e[l],a(t)!==!1)if(i(t)){if(r=c(t),null==r)continue;o(r)===!1&&(r=[r]),e.splice.apply(e,[l,1].concat(r)),l--,u+=r.length}else n(t)}function r(n){return 35!==n.charCodeAt(0)?!1:0===n.indexOf("#if ")}function i(n){var e=!1;for(var t in n)if(r(t))e=!0;else if(t!==p)return!1;return e===!0}function u(n){var e=n.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(n,e,t){return s(t,e)?n:"."===t[e-1]?n:'getter("'+n+'")'}),t=new Function("getter","return !!("+e+")");try{return t(f)}catch(r){logger.error("<config:condition-object> Evalulation error",n,r)}return!1}function f(n){var e=l(h,n);return null!=e?e:(e=l(g,n),null!=e?e:null)}function c(n){for(var e in n)if(e!==p&&u(e))return n[e];return n[p]}function s(n,e){for(var t,r=!1,i=!1;--e>-1;){if(t=n.charCodeAt(e),34===t){if(i)continue;if(r&&"\\"===n[e-1])continue;r=!r}if(39===t){if(r)continue;if(i&&"\\"===n[e-1])continue;i=!i}}return i||r}y=function(e,t,r){g=t,h=r,n(e)};var g,h,p="default"}();var m=function(){var n;!function(){n=function(n,e){var t={exports:{}},r=t.exports;try{new Function("module","exports",e)(t,r)}catch(i){logger.error("<config> Configuration evaluation error",n,i)}return t.exports===r&&0===Object.keys(t.exports).length&&logger.error("<config> Define `module.exports = ` in a file to export configuration",n),t.exports}}();var e;!function(){e=function(e,i,o){var a,u=new r.Uri(i);if(t.File.exists(u)&&(a=new t.File(u)),null==a&&u.isRelative()&&"undefined"!=typeof include&&(u=new r.Uri(include.location).combine(i),t.File.exists(u)&&(a=new t.File(u))),null==a)return o.optional!==!0&&logger.error("<config> Configuration file not found",i).warn("Set `optional:true`, if configuration is not strict required"),null;var f=a.read();"string"==typeof f&&(o.writable=!1,f=n(u.toLocalFile(),f));var c=o.getterProperty;return c&&(f=l(f,c)),f}}();var o={},u=i.Collection(Object,{Base:i.Deferred,add:function(n){return n.length&&"function"==typeof n.forEach?void n.forEach(function(n){this.push(n)},this):void this.push(n)},load:function(n,e){function t(n,e,t){return function(){w(t,e),n&&n(e,t)}}var r,o,a,u=this,l=u.length;null==e&&(e=-1);for(var f=0,c=new i.Await;++e<l;){if(r=u[e],++f>1&&r.data.sync){c.always(function(){u.load(n,e-1)});break}o=r.data&&r.data.beforeRead,a=r.data&&r.data.afterRead,o&&o(r,n),r.read(n),r.done(t(a,r,n)).always(c.delegate(null,!1))}return e>l-1&&c.always(u.resolveDelegate()),u}}),f={create:function(n){"string"==typeof n&&(n=[{path:n}]),Array.isArray(n)===!1&&(n=[n]);var e,t,r,i=n.length,a=-1,l=new u;n:for(;++a<i;)if(r=n[a],null!=r){for(t in o)if(e=o[t],e.canHandle(r)){l.add(new e(r));continue n}logger.error("<unhandled configuration source> :",r)}return l},register:function(n,e){o[n]=e}};return function(){f.register("file",i({Base:i.Deferred,Static:{canHandle:function(n){var e=n.path;return"string"!=typeof e?!1:-1!==e.search(/[\*\?]/g)?!1:"/"===e[e.length-1]?!1:!0}},Construct:function(n){this.data=n,n.path=p(n.path)},read:function(n){return this.defer(),this.config=e(n,this.data.path,this.data),this[null==this.config?"reject":"resolve"]()},write:function(n){this.data.writable===!0&&(this.config=d(this.config,n),new t.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){f.register("files",i({Base:i.Deferred,Static:{canHandle:function(n){return Array.isArray(n.files)}},Construct:function(n){var e=o.file;return n.files.map(function(n){return new e({path:n})})}}))}(),function(){f.register("directory",i({Base:i.Deferred,Static:{canHandle:function(n){var e=n.path;return"string"!=typeof e?!1:-1!==e.search(/[\*\?]/g)?!0:"/"===e[e.length-1]?!0:!1}},Construct:function(n){var e,r,i=n.path.replace(/\\/g,"/"),o=i.search(/[\*\?]/g),a=i.lastIndexOf("/",o);-1===o?e=i:(e=i.substring(0,a+1),r=i.substring(a+1));var u=new t.Directory(e).readFiles(r).files.map(function(n){return n.uri.toString()});return f.create([{files:u}]).toArray()}}))}(),function(){function n(n,e){return new(i({Base:i.Serializable,Store:i.MongoStore.Single(n),_id:e}))}f.register("mongo",i({Base:i.Deferred,Static:{canHandle:function(n){return"mongo"in n}},Construct:function(n){this.data=n,n.settings&&i.MongoStore.settings(n.settings),null==n.writable&&(n.writable=!0)},read:function(e){var t=e.mongodb;t&&i.MongoStore.settings(t);var r=this;return n(this.data.mongo).fetch().done(function(){r.config=this.toJSON(),r._id=this._id,delete r.config._id,r.resolve()}).fail(function(n){r.reject(n)}),r},write:function(n){this.config=d(this.config,n);var e=this;return i.MongoStore.resolveCollection(this.data.mongo).done(function(n){n.update({},e.config,{upsert:!0,multi:!1},function(n){return n?e.reject(n):void e.resolve()})}),e}}))}(),function(){f.register("embedded",i({Base:i.Deferred,Static:{canHandle:function(n){return a(n.config)}},Construct:function(n){this.data=n,this.data.writable=!1,this.config=n.config},read:function(){this.resolve()}}))}(),function(){f.register("custom",i({Static:{canHandle:function(n){return"function"==typeof n}},Construct:function(n){return new n}}))}(),f}(),b=i({Base:i.Deferred,Construct:function(n){this.$data=n,this.$sources=m.create(n),this.$parallelReads=new i.Await},Static:{fetch:function(n){return new b(n).$read()},create:function(n){return new b(n)}},$parallelReads:null,$sources:null,$cli:null,$get:function(n){return l(this,n)},$set:function(n,e){f(this,n,e)},$extend:function(n){d(this,n)},$read:function(n){var e=this,t=this.$parallelReads.delegate(null,!1),r=null==n?this.$sources:m.create(n);return this.$parallelReads._always=null,this.$parallelReads.always(this._onComplete),this.$cli=u(),this.defer(),r.load(e).done(function(){var n,r=e.$cli.params;for(n in r)f(e,n,r[n]);h(e),y(e,e,e.$cli.params),t()}),e},Self:{_onComplete:function(){this.resolve(this)}},$write:function(n){d(n);for(var e=this.$sources,t=e.length;--t>-1;)if(e[t].data.writable)return this.defer(),e[t].write(n),e[t].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return logger.error(r),this.reject(r)},Override:{toJSON:function(){var n,e=this.super();for(n in e)"$"===n[0]&&delete e[n];return e}}});return e.Config=b});