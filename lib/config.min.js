/*!
 * config v0.1.21
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
!function(t,n){"use strict";function e(){return n(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=t||i,"function"==typeof define&&define.amd?define(e):(e(),void("undefined"!=typeof module&&(module.exports=r.Config)))}(this,function(t,n){"use strict";var e,r;!function(){r=t.atma&&t.atma.Class||t.Class||require("atma-libs/exports").Class,e=t.io||require("atma-io")}();var i,o;!function(){i=function(t){return null!=t&&"number"==typeof t.length&&"function"==typeof t.splice},o=function(t){return null!=t&&"object"==typeof t}}();var a;!function(){var t;a=function(){if(null!=t)return t;for(var n,e,r,i=process.argv,o=i.length,a=2,s={},f=[];o>a;a++)r=i[a],"-"!==r[0]?f.push(r):(n=r.replace(/^[\-]+/,""),o-1>a&&"-"!==i[a+1][0]?(e=i[a+1],a++):e=!0,s[n]=e);return t={params:s,args:f}}}();var s,f,u,l,c,h,g;!function(){s=function(t,n){for(var e=n.split("."),r=e.length,i=-1;++i<r;){if(null==t)return null;t=t[e[i]]}return t},f=function(t,n,e){for(var r,i=n.split("."),o=i.length,a=-1;++a<o-1;)r=i[a],null==t[r]&&(t[r]={}),t=t[r];t[i[a]]=e},u=function(t,n){for(var e in n)null==t[e]&&(t[e]=n[e]);return t},l=function(t,n){for(var e in n)null!=n[e]&&(t[e]=n[e]);return t},c=function(t,n){if(null==t&&(t={}),null==n)return t;if(i(t)&&i(n)){for(var e,r=0,a=n.length;a>r;r++)e=n[r],null!=e&&t.push(o(e)?c({},e):e);return t}if(!o(n)&&!o(t))return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),t;var s,f;for(s in n)if(f=n[s],33!==s.charCodeAt(0)){if(null!=f)if(null!=t[s])if(i(f)){if(i(t[s])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",s,f,t[s]),t[s]=f;continue}c(t[s],f)}else t[s]=o(f)&&o(t[s])?c(t[s],f):f;else t[s]=f}else t[s.substring(1)]=f;return t},h=function(t,n,e){var r=s(t,n);return null==r?f(t,n,null==e?{}:e):void(typeof r!=typeof e&&logger.error("<obj_ensureProperty> type missmatch",typeof r,typeof e,(new Error).stack))},g=function(t,n){if(null!=t)if(null==n&&(n=t),i(t))for(var e=t.length;--e>-1;)g(t[e],n);else if(o(t)){var r,a;for(r in t)if(a=t[r],null!=a&&"_"!==r[0])if(o(a))g(a,n);else if("string"==typeof a){var f=a.trim();if("#["!==f.substring(0,2))continue;if(f=f.substring(2,f.length-1).trim(),t[r]=s(n,f),null==t[r]){console.warn("<config: obj_interpolate: property not exists in root",a);continue}}}}}();var d;!function(){function t(t){i(t)&&e(t),o(t)&&n(t)}function n(n){var e,i;for(e in n)i=n[e],o(i)!==!1&&(r(e)?f(e)&&c(n,i):a(i)?n[e]=l(i):t(i))}function e(n){for(var e,r,s=n.length,f=-1;++f<s;)if(e=n[f],o(e)!==!1)if(a(e)){if(r=l(e),null==r)continue;i(r)===!1&&(r=[r]),n.splice.apply(n,[f,1].concat(r)),f--,s+=r.length}else t(e)}function r(t){return 35!==t.charCodeAt(0)?!1:0===t.indexOf("#if ")}function a(t){for(var n in t)if(!r(n)&&n!==p)return!1;return!0}function f(t){var n=t.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(t){return'getter("'+t+'")'}),e=new Function("getter","return !!("+n+")");try{return e(u)}catch(r){logger.error("<config:condition-object> Evalulation error",t,r)}return!1}function u(t){var n;return n=s(g,t),null!=n?n:(n=s(h,t),null!=n?n:null)}function l(t){for(var n in t)if(n!==p&&f(n))return t[n];return t[p]}var h,g,p="default";d=function(n,e,r){h=e,g=r,t(n)}}();var p,v;!function(){function t(t){var n=process.env,r=n[t];if(null!=r)return r;switch(t){case"TEMP":r=n.TMP||n.TMPDIR;break;case"APP":r=e.env.applicationDir.toLocalDir()}return null==r&&logger.error("<config:special-folder> Not resolved",t),v(r||n.HOME||t)}var n=/^%(\w+)%/,r=/[\/]{2,}/g,i={};p=function(e){return n.test(e)===!1?e:(e=v(e).replace(n,function(n,e){return e=e.toUpperCase(),null!=i[e]?i[e]:i[e]=t(e)}).replace(r,"/"),"file://"+e)},v=function(t){return t.replace(/\\/g,"/")}}();var w;!function(){w=function(t,n){if(null!=n.config){var e=n.data.setterProperty;e&&(h(config,e,{}),t=s(config,e)),c(t,n.config)}}}();var y=function(){var t={},n=r.Collection(Object,{Base:r.Deferred,add:function(t){return t.length&&"function"==typeof t.forEach?void t.forEach(function(t){this.push(t)},this):void this.push(t)},load:function(t,n){function e(t,n,e){return function(){w(e,n),t&&t(n,e)}}var i,o,a,s=this,f=s.length;null==n&&(n=-1);for(var u=0,l=new r.Await;++n<f;){if(i=s[n],++u>1&&i.data.sync){l.always(function(){s.load(t,n-1)});break}o=i.data&&i.data.beforeRead,a=i.data&&i.data.afterRead,o&&o(i,t),i.read(t),i.done(e(a,i,t)).always(l.delegate(null,!1))}return n>f-1&&l.always(s.resolveDelegate()),s}}),i={create:function(e){"string"==typeof e&&(e=[{path:e}]),Array.isArray(e)===!1&&(e=[e]);var r,i,o,a=e.length,s=-1,f=new n;t:for(;++s<a;)if(o=e[s],null!=o){for(i in t)if(r=t[i],r.canHandle(o)){f.add(new r(o));continue t}logger.error("<unhandled configuration source> :",o)}return f},register:function(n,e){t[n]=e}};return function(){function t(t,n){var e={exports:{}},r=e.exports;try{new Function("module","exports",n)(e,r)}catch(i){console.error("<config> Configuration evaluation error",t,i)}return 0===Object.keys(e.exports).length&&logger.error("<config> Define `module.exports = ` in a file to export configuration",t).log(" - (`global.config = ` support is removed)".yellow),e.exports}i.register("file",r({Base:r.Deferred,Static:{canHandle:function(t){var n=t.path;return"string"!=typeof n?!1:-1!==n.search(/[\*\?]/g)?!1:"/"===n[n.length-1]?!1:!0}},Construct:function(t){this.data=t,t.path=p(t.path)},read:function(n){this.defer();var r=new e.File(this.data.path);if(r.exists()===!1)return this.data.optional?this.resolve():(console.error("<config> Configuration file not found",this.data.path),this.reject());this.config=r.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=t(this.data.path,this.config));var i=this.data.getterProperty;return i&&(this.config=s(this.config,i)),d(this.config,n,a().params),this.resolve()},write:function(t){this.data.writable===!0&&(this.config=c(this.config,t),new e.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){i.register("files",r({Base:r.Deferred,Static:{canHandle:function(t){return Array.isArray(t.files)}},Construct:function(n){var e=t.file;return n.files.map(function(t){return new e({path:t})})},read:function(t){this.defer();var n=new e.File(this.data.path);if(n.exists()===!1)return this.data.optional?this.resolve():(console.error("<config> Configuration file not found",this.data.path),this.reject());this.config=n.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var r=this.data.getterProperty;return r&&(this.config=s(this.config,r)),d(this.config,t,a().params),this.resolve()},write:function(t){this.data.writable===!0&&(this.config=c(this.config,t),new e.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){i.register("directory",r({Base:r.Deferred,Static:{canHandle:function(t){var n=t.path;return"string"!=typeof n?!1:-1!==n.search(/[\*\?]/g)?!0:"/"===n[n.length-1]?!0:!1}},Construct:function(t){var n,r,o=t.path.replace(/\\/g,"/"),a=o.search(/[\*\?]/g),s=o.lastIndexOf("/",a);-1===a?n=o:(n=o.substring(0,s+1),r=o.substring(s+1));var f=new e.Directory(n).readFiles(r).files.map(function(t){return t.uri.toString()});return i.create([{files:f}]).toArray()}}))}(),function(){function t(t,n){return new(r({Base:r.Serializable,Store:r.MongoStore.Single(t),_id:n}))}i.register("mongo",r({Base:r.Deferred,Static:{canHandle:function(t){return"mongo"in t}},Construct:function(t){this.data=t,t.settings&&r.MongoStore.settings(t.settings),null==t.writable&&(t.writable=!0)},read:function(n){var e=n.mongodb;e&&r.MongoStore.settings(e);var i=this;return t(this.data.mongo).fetch().done(function(){i.config=this.toJSON(),i._id=this._id,delete i.config._id,i.resolve()}).fail(function(t){i.reject(t)}),i},write:function(t){this.config=c(this.config,t);var n=this;return r.MongoStore.resolveCollection(this.data.mongo).done(function(t){t.update({},n.config,{upsert:!0,multi:!1},function(t){return t?n.reject(t):void n.resolve()})}),n}}))}(),function(){i.register("embedded",r({Base:r.Deferred,Static:{canHandle:function(t){return o(t.config)}},Construct:function(t){this.data=t,this.data.writable=!1,this.config=t.config},read:function(){this.resolve()}}))}(),function(){i.register("custom",r({Static:{canHandle:function(t){return"function"==typeof t}},Construct:function(t){return new t}}))}(),i}(),m=r({Base:r.Deferred,Construct:function(t){this.$data=t,this.$sources=y.create(t),this.$parallelReads=new r.Await},Static:{fetch:function(t){return new m(t).$read()},create:function(t){return new m(t)}},$parallelReads:null,$sources:null,$cli:null,$get:function(t){return s(this,t)},$set:function(t,n){f(this,t,n)},$extend:function(t){c(this,t)},$read:function(t){var n=this,e=this.$parallelReads.delegate(null,!1),r=null==t?this.$sources:y.create(t);return this.$parallelReads._always=null,this.$parallelReads.always(this._onComplete),this.$cli=a(),this.defer(),r.load(n).done(function(){var t,r=n.$cli.params;for(t in r)f(n,t,r[t]);g(n),e()}),n},Self:{_onComplete:function(){this.resolve(this)}},$write:function(t){c(t);for(var n=this.$sources,e=n.length;--e>-1;)if(n[e].data.writable)return this.defer(),n[e].write(t),n[e].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return logger.error(r),this.reject(r)},Override:{toJSON:function(){var t,n=this.super();for(t in n)"$"===t[0]&&delete n[t];return n}}});return n.Config=m});