/*!
 * config v0.1.5
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
(function(e,r){"use strict";function t(){return r(o,n)}var n,o="undefined"==typeof window||null==window.navigator?global:window;return n=e||o,"function"==typeof define&&define.amd?define(t):(t(),"undefined"!=typeof module&&(module.exports=n.Config),void 0)})(this,function(global,exports){"use strict";var io,Class;(function(){Class=global.atma&&global.atma.Class||global.Class||require("atma-libs/exports").Class,io=global.io||require("atma-io")})();var is_Array,is_Object;(function(){is_Array=function(e){return null!=e&&"number"==typeof e.length&&"function"==typeof e.splice},is_Object=function(e){return null!=e&&"object"==typeof e}})();var cli_arguments;(function(){cli_arguments=function(){for(var e,r,t,n=process.argv,o=n.length,i=2,a={},s=[];o>i;i++)t=n[i],"-"!==t[0]?s.push(t):(e=t.replace(/^[\-]+/,""),o-1>i&&"-"!==n[i+1][0]?(r=n[i+1],i++):r=!0,a[e]=r);return{params:a,args:s}}})();var obj_getProperty,obj_setProperty,obj_defaults,obj_extend,obj_deepExtend,obj_ensureProperty;(function(){obj_getProperty=function(e,r){for(var t=r.split("."),n=t.length,o=-1;n>++o;){if(null==e)return null;e=e[t[o]]}return e},obj_setProperty=function(e,r,t){for(var n,o=r.split("."),i=o.length,a=-1;i-1>++a;)n=o[a],null==e[n]&&(e[n]={}),e=e[n];e[o[a]]=t},obj_defaults=function(e,r){for(var t in r)null==e[t]&&(e[t]=r[t]);return e},obj_extend=function(e,r){for(var t in r)null!=r[t]&&(e[t]=r[t]);return e},obj_deepExtend=function(e,r){if(null==r)return e;if(Array.isArray(e)&&Array.isArray(r)){for(var t,n=0,o=r.length;o>n;n++)t=r[n],-1===e.indexOf(t)&&e.push(t);return e}if("object"!=typeof r&&"object"!=typeof e)return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),e;var i,a;for(i in r)if(a=r[i],null!=e[i])if(Array.isArray(a)){if(Array.isArray(e[i])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",i,a,e[i]),e[i]=a;continue}obj_deepExtend(e[i],a)}else e[i]="object"!=typeof a||"object"!=typeof e[i]?a:obj_deepExtend(e[i],a);else e[i]=a;return e},obj_ensureProperty=function(e,r,t){var n=obj_getProperty(e,r);return null==n?obj_setProperty(e,r,null==t?{}:t):(typeof n!=typeof t&&logger.error("<obj_ensureProperty> type missmatch",typeof n,typeof t,Error().stack),void 0)}})();var cond_rewrite;(function(){function e(e){is_Array(e)&&t(e),is_Object(e)&&r(e)}function r(r){for(var t in r)is_Object(r)!==!1&&(n(t)?i(t)&&obj_deepExtend(r,r[t]):o(r[t])?r[t]=s(r[t]):e(r[t]))}function t(r){for(var t,n,i=r.length,a=-1;i>++a;)if(t=r[a],is_Object(t)!==!1)if(o(t)){if(n=s(t),null==n)continue;is_Array(n)===!1&&(n=[n]),r.splice.apply(r,[a,1].concat(n)),a--,i+=n.length}else e(t)}function n(e){return 35!==e.charCodeAt(0)?!1:0===e.indexOf("#if ")}function o(e){for(var r in e)if(!n(r)&&r!==l)return!1;return!0}function i(e){var r=e.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(e){return'getter("'+e+'")'}),t=Function("getter","return !!("+r+")");try{return t(a)}catch(n){logger.error("<config:condition-object> Evalulation error",e,n)}return!1}function a(e){var r;return r=obj_getProperty(c,e),null!=r?r:(r=obj_getProperty(u,e),null!=r?r:null)}function s(e){for(var r in e)if(r!==l&&i(r))return e[r];return e[l]}var u,c,l="default";cond_rewrite=function(r,t,n){u=t,c=n,e(r)}})();var path_handleSpecialFolder,path_normalize;(function(){function e(e){var r=process.env,t=r[e];if(null!=t)return t;switch(e){case"TEMP":t=r.TMP||r.TMPDIR;break;case"APP":return io.env.applicationDir.toLocalDir()}return null!=t?t:(logger.error("<config:special-folder> Not resolved",e),r.HOME||e)}var r=/%([^%]+)%/g,t=/[\/]{2,}/g,n={};path_handleSpecialFolder=function(o){return r.test(o)===!1?o:path_normalize(o).replace(r,function(r,t){return t=t.toUpperCase(),null!=n[t]?n[t]:n[t]=e(t)}).replace(t,"/")},path_normalize=function(e){return e.replace(/\\/g,"/")}})();var SourceFactory=function(){var Handlers={},Sources=Class.Collection(Object,{Base:Class.Await,add:function(e){return e.length&&"function"==typeof e.forEach?(e.forEach(function(e){this.push(e)},this),void 0):(this.push(e),void 0)}}),SourceFactory={loadSources:function(e,r){function t(e,r,t){return null==e?null:function(){e(r,t)}}var n,o,i,a,s=e.length,u=-1,c=new Sources;e:for(;s>++u;){i=e[u];for(o in Handlers)if(n=Handlers[o],n.canHandle(i)){c.add(new n(i));continue e}logger.error("<unhandled configuration source> :",i)}var l,f;for(u=c.length;--u>-1;)a=c[u],l=a.data&&a.data.beforeRead,f=a.data&&a.data.afterRead,l&&l(a,r),a.read(r),a.done(t(f,a,r)).always(c.delegate(null,!1));return c},register:function(e,r){Handlers[e]=r}};return function(){function module_eval(path,script){var module={exports:{}},exports=module.exports;try{eval(script)}catch(error){console.error("<config> Configuration evaluation error",path,error)}return module.exports}SourceFactory.register("file",Class({Base:Class.Deferred,Static:{canHandle:function(e){var r=e.path;return"string"!=typeof r?!1:-1!==r.search(/\*\?/g)?!1:"/"===r[r.length-1]?!1:!0}},Construct:function(e){this.data=e,e.path=path_handleSpecialFolder(e.path)},read:function(e){this.defer();var r=new io.File(this.data.path);if(r.exists()===!1)return console.error("<config> Configuration file not found",this.data.path),this.reject();this.config=r.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var t=this.data.getterProperty;return t&&(this.config=obj_getProperty(this.config,t)),cond_rewrite(this.config,e,cli_arguments().params),this.resolve()},write:function(){this.data.writable===!0&&new io.File(this.data.path).write(this.config)}}))}(),function(){SourceFactory.register("directory",Class({Base:Class.Deferred,Static:{canHandle:function(e){var r=e.path;return"string"!=typeof r?!1:-1!==r.search(/\*\?/g)?!0:"/"===r[r.length-1]?!0:!1}},Construct:function(e){var r,t,n=e.path.replace(/\\/g,"/"),o=n.search(/\*\?/g),i=n.lastIndexOf("/",o);return-1===o?r=n:(r=n.substring(0,i),t=n.substring(i+1)),new io.Directory(r).readFiles(t).files.map(function(e){return e.uri.toLocalFile()})}}))}(),function(){var e={read:function(e){var r=e.mongodb;return r&&Class.MongoStore.settings(data.mongoSettings),this.fetch()},write:function(e){this.data.writable===!0&&(obj_deepExtend(this,e),this.save())}};SourceFactory.register("mongo",Class({Static:{canHandle:function(e){return"mongo"in e}},Construct:function(r){r.settings&&Class.MongoStore.settings(r.settings),null==r.writable&&(r.writable=!0),new(Class({Base:e,Store:Class.MongoStore.Single(r.mongo)}))}}))}(),function(){SourceFactory.register("custom",Class({Static:{canHandle:function(e){return"function"==typeof e}},Construct:function(e){return new e}}))}(),SourceFactory}(),Config=Class({Base:Class.Deferred,Construct:function(){},Static:{fetch:function(e){return(new Config).$read(e)}},$read:function(e){var r=this;return this.$cli=cli_arguments(),this.$sources=SourceFactory.loadSources(e,r).done(function(){this.each(function(e){var t=r,n=e.data.setterProperty;n&&(obj_ensureProperty(r,n,{}),t=obj_getProperty(r,n)),obj_deepExtend(t,e.config)});var e,t=r.$cli.params;for(e in t)obj_setProperty(r,e,t[e]);r.resolve()}),r},$write:function(e){obj_deepExtend(e);for(var r=this.$sources,t=r.length;--t>-1;)if(r[t].data.writable)return r[t].write(e),this;return logger.error("<config:write> Writable source not defined."),this}});return exports.Config=Config});