/*!
 * config v0.1.2
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
(function(t,e){"use strict";function r(){return e(o,n)}var n,o="undefined"==typeof window||null==window.navigator?global:window;return n=t||o,"function"==typeof define&&define.amd?define(r):(r(),"undefined"!=typeof module&&(module.exports=n.Config),void 0)})(this,function(global,exports){"use strict";var io,Class;(function(){Class=global.atma&&global.atma.Class||global.Class||require("atma-libs/exports").Class,io=global.io||require("atma-io")})();var cli_arguments;(function(){cli_arguments=function(){for(var t,e,r,n=process.argv,o=n.length,a=2,i={},s=[];o>a;a++)r=n[a],"-"!==r[0]?s.push(r):(t=r.replace(/^[\-]+/,""),o-1>a&&"-"!==n[a+1][0]?(e=n[a+1],a++):e=!0,i[t]=e);return{params:i,args:s}}})();var obj_getProperty,obj_setProperty,obj_defaults,obj_extend,obj_deepExtend,obj_ensureProperty;(function(){obj_getProperty=function(t,e){for(var r=e.split("."),n=r.length,o=-1;n>++o;){if(null==t)return null;t=t[r[o]]}return t},obj_setProperty=function(t,e,r){for(var n,o=e.split("."),a=o.length,i=-1;a-1>++i;)n=o[i],null==t[n]&&(t[n]={}),t=t[n];t[o[i]]=r},obj_defaults=function(t,e){for(var r in e)null==t[r]&&(t[r]=e[r]);return t},obj_extend=function(t,e){for(var r in e)null!=e[r]&&(t[r]=e[r]);return t},obj_deepExtend=function(t,e){if(null==e)return t;if(Array.isArray(t)&&Array.isArray(e)){for(var r,n=0,o=e.length;o>n;n++)r=e[n],-1===t.indexOf(r)&&t.push(r);return t}if("object"!=typeof e&&"object"!=typeof t)return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),t;var a,i;for(a in e)if(i=e[a],null!=t[a])if(Array.isArray(i)){if(Array.isArray(t[a])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",a,i,t[a]),t[a]=i;continue}obj_deepExtend(t[a],i)}else t[a]="object"!=typeof i||"object"!=typeof t[a]?i:obj_deepExtend(t[a],i);else t[a]=i;return t},obj_ensureProperty=function(t,e,r){var n=obj_getProperty(t,e);return null==n?obj_setProperty(t,e,null==r?{}:r):(typeof n!=typeof r&&logger.error("<obj_ensureProperty> type missmatch",typeof n,typeof r,Error().stack),void 0)}})();var path_handleSpecialFolder,path_normalize;(function(){function t(t){var e=process.env,r=e[t];if(null!=r)return r;switch(t){case"TEMP":r=e.TMP||e.TMPDIR}return null!=r?r:(logger.error("<config:special-folder> Not resolved",t),e.HOME||t)}var e=/%([^%]+)%/g,r=/[\/]{2,}/g,n={};path_handleSpecialFolder=function(o){return e.test(o)===!1?o:path_normalize(o).replace(e,function(e,r){return r=r.toUpperCase(),null!=n[r]?n[r]:n[r]=t(r)}).replace(r,"/")}})();var SourceFactory=function(){var Handlers={},Sources=Class.Collection(Object,{Base:Class.Await,add:function(t){return t.length&&"function"==typeof t.forEach?(t.forEach(function(t){this.push(t)},this),void 0):(this.push(t),void 0)}}),SourceFactory={loadSources:function(t,e){var r,n,o,a=t.length,i=-1,s=new Sources;t:for(;a>++i;){o=t[i];for(n in Handlers)if(r=Handlers[n],r.canHandle(o)){s.add(new r(o));continue t}logger.error("<unhandled configuration source> :",o)}for(i=s.length;--i>-1;)s[i].read(e).always(s.delegate(null,!1));return s},register:function(t,e){Handlers[t]=e}};return function(){function module_eval(path,script){var module={exports:{}},exports=module.exports;try{eval(script)}catch(error){console.error("<config> Configuration evaluation error",path,error)}return module.exports}SourceFactory.register("file",Class({Base:Class.Deferred,Static:{canHandle:function(t){var e=t.path;return"string"!=typeof e?!1:-1!==e.search(/\*\?/g)?!1:"/"===e[e.length-1]?!1:!0}},Construct:function(t){this.data=t,t.path=path_handleSpecialFolder(t.path)},read:function(t){this.defer();var e=new io.File(this.data.path);if(e.exists()===!1)return console.error("<config> Configuration file not found",this.data.path),this.reject();this.config=e.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var r=this.data.getterProperty;return r&&(this.config=obj_getProperty(this.config,r)),cond_rewrite(this.config,t,cli_arguments().params),this.resolve()},write:function(){this.data.writable===!0&&new io.File(this.data.path).write(this.config)}}))}(),function(){SourceFactory.register("directory",Class({Base:Class.Deferred,Static:{canHandle:function(t){var e=t.path;return"string"!=typeof e?!1:-1!==e.search(/\*\?/g)?!0:"/"===e[e.length-1]?!0:!1}},Construct:function(t){var e,r,n=t.path.replace(/\\/g,"/"),o=n.search(/\*\?/g),a=n.lastIndexOf("/",o);return-1===o?e=n:(e=n.substring(0,a),r=n.substring(a+1)),new io.Directory(e).readFiles(r).files.map(function(t){return t.uri.toLocalFile()})}}))}(),function(){var t={read:function(t){var e=t.mongodb;return e&&Class.MongoStore.settings(data.mongoSettings),this.fetch()},write:function(t){this.data.writable===!0&&(obj_deepExtend(this,t),this.save())}};SourceFactory.register("mongo",Class({Static:{canHandle:function(t){return"mongo"in t}},Construct:function(e){e.settings&&Class.MongoStore.settings(e.settings),null==e.writable&&(e.writable=!0),new(Class({Base:t,Store:Class.MongoStore.Single(e.mongo)}))}}))}(),SourceFactory}(),SourceFactory=function(){var Handlers={},Sources=Class.Collection(Object,{Base:Class.Await,add:function(t){return t.length&&"function"==typeof t.forEach?(t.forEach(function(t){this.push(t)},this),void 0):(this.push(t),void 0)}}),SourceFactory={loadSources:function(t,e){var r,n,o,a=t.length,i=-1,s=new Sources;t:for(;a>++i;){o=t[i];for(n in Handlers)if(r=Handlers[n],r.canHandle(o)){s.add(new r(o));continue t}logger.error("<unhandled configuration source> :",o)}for(i=s.length;--i>-1;)s[i].read(e).always(s.delegate(null,!1));return s},register:function(t,e){Handlers[t]=e}};return function(){function module_eval(path,script){var module={exports:{}},exports=module.exports;try{eval(script)}catch(error){console.error("<config> Configuration evaluation error",path,error)}return module.exports}SourceFactory.register("file",Class({Base:Class.Deferred,Static:{canHandle:function(t){var e=t.path;return"string"!=typeof e?!1:-1!==e.search(/\*\?/g)?!1:"/"===e[e.length-1]?!1:!0}},Construct:function(t){this.data=t,t.path=path_handleSpecialFolder(t.path)},read:function(t){this.defer();var e=new io.File(this.data.path);if(e.exists()===!1)return console.error("<config> Configuration file not found",this.data.path),this.reject();this.config=e.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var r=this.data.getterProperty;return r&&(this.config=obj_getProperty(this.config,r)),cond_rewrite(this.config,t,cli_arguments().params),this.resolve()},write:function(){this.data.writable===!0&&new io.File(this.data.path).write(this.config)}}))}(),function(){SourceFactory.register("directory",Class({Base:Class.Deferred,Static:{canHandle:function(t){var e=t.path;return"string"!=typeof e?!1:-1!==e.search(/\*\?/g)?!0:"/"===e[e.length-1]?!0:!1}},Construct:function(t){var e,r,n=t.path.replace(/\\/g,"/"),o=n.search(/\*\?/g),a=n.lastIndexOf("/",o);return-1===o?e=n:(e=n.substring(0,a),r=n.substring(a+1)),new io.Directory(e).readFiles(r).files.map(function(t){return t.uri.toLocalFile()})}}))}(),function(){var t={read:function(t){var e=t.mongodb;return e&&Class.MongoStore.settings(data.mongoSettings),this.fetch()},write:function(t){this.data.writable===!0&&(obj_deepExtend(this,t),this.save())}};SourceFactory.register("mongo",Class({Static:{canHandle:function(t){return"mongo"in t}},Construct:function(e){e.settings&&Class.MongoStore.settings(e.settings),null==e.writable&&(e.writable=!0),new(Class({Base:t,Store:Class.MongoStore.Single(e.mongo)}))}}))}(),SourceFactory}(),Config=Class({Base:Class.Deferred,Construct:function(t){this.data=t},Static:{fetch:function(t){return new Config(t).$read()}},$read:function(){var t=this,e=this.data;return this._sources=SourceFactory.loadSources(e,t).done(function(){this.each(function(e){var r=t,n=e.data.setterProperty;n&&(obj_ensureProperty(t,n,{}),r=obj_getProperty(t,n)),obj_deepExtend(r,e.config)}),t.$cli=cli_arguments();var e,r=t.$cli.params;for(e in r)obj_setProperty(t,e,r[e]);t.resolve()}),t},$write:function(t){obj_deepExtend(t);for(var e=this._sources,r=e.length;--r>-1;)if(e[r].data.writable)return e[r].write(t),this;return logger.error("<config:write> Writable source not defined."),this}});return exports.Config=Config});