/*!
 * config v0.1.31
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
!function(n,t){"use strict";function e(){return t(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=n||i,"function"==typeof define&&define.amd?define(e):(e(),void("undefined"!=typeof module&&(module.exports=r.Config)))}(this,function(n,t){"use strict";var e,r,i,o;!function(){var t=n;null==t.Class&&n.atma&&(t=n.atma),null==t.Class&&(t=require("atma-libs/exports")),i=t.Class,r=t.net,e=n.io||require("atma-io"),o=n.logger||require("atma-logger")}();var a,u;!function(){a=function(n){return null!=n&&"number"==typeof n.length&&"function"==typeof n.splice},u=function(n){return null!=n&&"object"==typeof n}}();var f;!function(){var n;f=function(){if(null!=n)return n;for(var t,e,r,i=process.argv,o=i.length,a=2,u={},f=[];o>a;a++)r=i[a],"-"!==r[0]?f.push(r):(t=r.replace(/^[\-]+/,""),o-1>a&&"-"!==i[a+1][0]?(e=i[a+1],a++):e=!0,u[t]=e);return n={params:u,args:f}}}();var l,c,s,d,h,g,p;!function(){l=function(n,t){for(var e=t.split("."),r=e.length,i=-1;++i<r;){if(null==n)return null;n=n[e[i]]}return n},c=function(n,t,e){for(var r,i=t.split("."),o=i.length,a=-1;++a<o-1;)r=i[a],null==n[r]&&(n[r]={}),n=n[r];n[i[a]]=e},s=function(n,t){for(var e in t)null==n[e]&&(n[e]=t[e]);return n},d=function(n,t){for(var e in t)null!=t[e]&&(n[e]=t[e]);return n},h=function(n,t){if(null==n&&(n={}),null==t)return n;if(a(n)&&a(t)){for(var e,r=0,i=t.length;i>r;r++)e=t[r],null!=e&&n.push(u(e)?h({},e):e);return n}if(!u(t)&&!u(n))return o.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),n;var f,l;for(f in t)if(l=t[f],33!==f.charCodeAt(0)){if(null!=l)if(null!=n[f])if(a(l)){if(a(n[f])===!1){o.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",f,l,n[f]),n[f]=l;continue}h(n[f],l)}else n[f]=u(l)&&u(n[f])?h(n[f],l):l;else n[f]=l}else n[f.substring(1)]=l;return n},g=function(n,t,e){var r=l(n,t);return null==r?c(n,t,null==e?{}:e):void(typeof r!=typeof e&&o.error("<obj_ensureProperty> type missmatch",typeof r,typeof e,(new Error).stack))},p=function(n,t){if(null!=n)if(null==t&&(t=n),a(n))for(var e=n.length;--e>-1;)p(n[e],t);else if(u(n)){var r,i;for(r in n)if(i=n[r],null!=i&&"_"!==r[0])if(u(i))p(i,t);else if("string"==typeof i){var o=i.trim();if("#["!==o.substring(0,2))continue;if(o=o.substring(2,o.length-1).trim(),n[r]=l(t,o),null==n[r]){console.warn("<config: obj_interpolate: property not exists in root",i);continue}}}}}();var v,w;!function(){function n(n){var t=process.env,r=t[n];if(null!=r)return r;switch(n){case"TEMP":r=t.TMP||t.TMPDIR;break;case"APP":r=e.env.applicationDir.toLocalDir();break;case"APPDATA":r=t.HOME}return null==r&&o.error("<config:special-folder> Not resolved",n),w(r||t.HOME||n)}var t=/^%(\w+)%/,r=/[\/]{2,}/g,i={};v=function(e){return t.test(e)===!1?e:(e=w(e).replace(t,function(t,e){return e=e.toUpperCase(),null!=i[e]?i[e]:i[e]=n(e)}).replace(r,"/"),"file://"+e)},w=function(n){return n.replace(/\\/g,"/")}}();var y;!function(){y=function(n,t){if(null!=t.config){var e=t.data.setterProperty;e&&(g(config,e,{}),n=l(config,e)),h(n,t.config)}}}();var m;!function(){function n(n){a(n)&&e(n),u(n)&&t(n)}function t(t){var e,o,a;for(e in t)a=e.charCodeAt(0),36!==a&&(o=t[e],u(o)!==!1&&(r(e)?f(e)&&h(t,o):i(o)?t[e]=s(o):n(o)))}function e(t){for(var e,r,o=t.length,f=-1;++f<o;)if(e=t[f],u(e)!==!1)if(i(e)){if(r=s(e),null==r)continue;a(r)===!1&&(r=[r]),t.splice.apply(t,[f,1].concat(r)),f--,o+=r.length}else n(e)}function r(n){return 35!==n.charCodeAt(0)?!1:0===n.indexOf("#if ")}function i(n){var t=!1;for(var e in n)if(r(e))t=!0;else if(e!==v)return!1;return t===!0}function f(n){var t=n.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(n,t,e){return d(e,t)?n:"."===e[t-1]?n:'getter("'+n+'")'}),e=new Function("getter","return !!("+t+")");try{return e(c)}catch(r){o.error("<config:condition-object> Evalulation error",n,r)}return!1}function c(n){var t=l(p,n);return null!=t?t:(t=l(g,n),null!=t?t:null)}function s(n){for(var t in n)if(t!==v&&f(t))return n[t];return n[v]}function d(n,t){for(var e,r=!1,i=!1;--t>-1;){if(e=n.charCodeAt(t),34===e){if(i)continue;if(r&&"\\"===n[t-1])continue;r=!r}if(39===e){if(r)continue;if(i&&"\\"===n[t-1])continue;i=!i}}return i||r}m=function(t,e,r){g=e,p=r,n(t)};var g,p,v="default"}();var b=function(){var n;!function(){n=function(n,t){var e={exports:{}},r=e.exports;try{new Function("module","exports",t)(e,r)}catch(i){o.error("<config> Configuration evaluation error",n,i)}return e.exports===r&&0===Object.keys(e.exports).length&&o.error("<config> Define `module.exports = ` in a file to export configuration",n),e.exports}}();var t;!function(){t=function(t,i,a){var u,f=new r.Uri(i);if(e.File.exists(f)&&(u=new e.File(f)),null==u&&f.isRelative()&&"undefined"!=typeof include&&(f=new r.Uri(include.location).combine(i),e.File.exists(f)&&(u=new e.File(f))),null==u)return a.optional!==!0&&o.error("<config> Configuration file not found",i).warn("Set `optional:true`, if configuration is not strict required"),null;var c=u.read();"string"==typeof c&&(a.writable=!1,c=n(f.toLocalFile(),c));var s=a.getterProperty;return s&&(c=l(c,s)),c}}();var a={},f=i.Collection(Object,{Base:i.Deferred,add:function(n){return n.length&&"function"==typeof n.forEach?void n.forEach(function(n){this.push(n)},this):void this.push(n)},load:function(n,t){function e(n,t,e){return function(){y(e,t),n&&n(t,e)}}var r,o,a,u=this,f=u.length;null==t&&(t=-1);for(var l=0,c=new i.Await;++t<f;){if(r=u[t],++l>1&&r.data.sync){c.always(function(){u.load(n,t-1)});break}o=r.data&&r.data.beforeRead,a=r.data&&r.data.afterRead,o&&o(r,n),r.read(n),r.done(e(a,r,n)).always(c.delegate(null,!1))}return t>f-1&&c.always(u.resolveDelegate()),u}}),c={create:function(n){"string"==typeof n&&(n=[{path:n}]),Array.isArray(n)===!1&&(n=[n]);var t,e,r,i=n.length,u=-1,l=new f;n:for(;++u<i;)if(r=n[u],null!=r){for(e in a)if(t=a[e],t.canHandle(r)){l.add(new t(r));continue n}o.error("<unhandled configuration source> :",r)}return l},register:function(n,t){a[n]=t}};return function(){c.register("file",i({Base:i.Deferred,Static:{canHandle:function(n){var t=n.path;return"string"!=typeof t?!1:-1!==t.search(/[\*\?]/g)?!1:"/"===t[t.length-1]?!1:!0}},Construct:function(n){this.data=n,n.path=v(n.path)},read:function(n){return this.defer(),this.config=t(n,this.data.path,this.data),this[null==this.config?"reject":"resolve"]()},write:function(n){if(this.defer(),this.data.writable!==!0)return this.reject("Not writable");this.config=h(this.config,n);try{e.File.writeAsync(this.data.path,JSON.stringify(this.config)).pipe(this)}catch(t){this.reject("JSON.serialization "+String(t))}return this}}))}(),function(){c.register("files",i({Base:i.Deferred,Static:{canHandle:function(n){return Array.isArray(n.files)}},Construct:function(n){var t=a.file;return n.files.map(function(n){return new t({path:n})})}}))}(),function(){c.register("directory",i({Base:i.Deferred,Static:{canHandle:function(n){var t=n.path;return"string"!=typeof t?!1:-1!==t.search(/[\*\?]/g)?!0:"/"===t[t.length-1]?!0:!1}},Construct:function(n){var t,r,i=n.path.replace(/\\/g,"/"),o=i.search(/[\*\?]/g),a=i.lastIndexOf("/",o);-1===o?t=i:(t=i.substring(0,a+1),r=i.substring(a+1));var u=new e.Directory(t).readFiles(r).files.map(function(n){return n.uri.toString()});return c.create([{files:u}]).toArray()}}))}(),function(){function n(n,t){return new(i({Base:i.Serializable,Store:i.MongoStore.Single(n),_id:t}))}c.register("mongo",i({Base:i.Deferred,Static:{canHandle:function(n){return"mongo"in n}},Construct:function(n){this.data=n,n.settings&&i.MongoStore.settings(n.settings),null==n.writable&&(n.writable=!0)},read:function(t){var e=t.mongodb;e&&i.MongoStore.settings(e);var r=this;return n(this.data.mongo).fetch().done(function(){r.config=this.toJSON(),r._id=this._id,delete r.config._id,r.resolve()}).fail(function(n){r.reject(n)}),r},write:function(n){this.config=h(this.config,n);var t=this;return i.MongoStore.resolveCollection(this.data.mongo).done(function(n){n.update({},t.config,{upsert:!0,multi:!1},function(n){return n?t.reject(n):void t.resolve()})}),t}}))}(),function(){c.register("embedded",i({Base:i.Deferred,Static:{canHandle:function(n){return u(n.config)}},Construct:function(n){this.data=n,this.data.writable=!1,this.config=n.config},read:function(){this.resolve()}}))}(),function(){c.register("custom",i({Static:{canHandle:function(n){return"function"==typeof n}},Construct:function(n){return new n}}))}(),c}(),C=i({Base:i.Deferred,Construct:function(n){this.$data=n,this.$sources=b.create(n),this.$parallelReads=new i.Await},Static:{fetch:function(n){return new C(n).$read()},create:function(n){return new C(n)}},$parallelReads:null,$sources:null,$cli:null,$get:function(n){return l(this,n)},$set:function(n,t){c(this,n,t)},$extend:function(n){h(this,n)},$read:function(n){var t=this,e=this.$parallelReads.delegate(null,!1),r=null==n?this.$sources:b.create(n);return this.$parallelReads._always=null,this.$parallelReads.always(this._onComplete),this.$cli=f(),this.defer(),r.load(t).done(function(){var n,r=t.$cli.params;for(n in r)c(t,n,r[n]);p(t),m(t,t,t.$cli.params),e()}),t},Self:{_onComplete:function(){this.resolve(this)}},$write:function(n){h(n);for(var t=this.$sources,e=t.length;--e>-1;)if(t[e].data.writable)return this.defer(),t[e].write(n),t[e].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return o.error(r),this.reject(r)},Override:{toJSON:function(){var n,t=this.super();for(n in t)"$"===n[0]&&delete t[n];return t}}});return t.Config=C});