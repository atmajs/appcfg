/*!
 * config v0.1.23
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
!function(n,e){"use strict";function t(){return e(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=n||i,"function"==typeof define&&define.amd?define(t):(t(),void("undefined"!=typeof module&&(module.exports=r.Config)))}(this,function(n,e){"use strict";var t,r;!function(){r=n.atma&&n.atma.Class||n.Class||require("atma-libs/exports").Class,t=n.io||require("atma-io")}();var i,o;!function(){i=function(n){return null!=n&&"number"==typeof n.length&&"function"==typeof n.splice},o=function(n){return null!=n&&"object"==typeof n}}();var a;!function(){var n;a=function(){if(null!=n)return n;for(var e,t,r,i=process.argv,o=i.length,a=2,u={},l=[];o>a;a++)r=i[a],"-"!==r[0]?l.push(r):(e=r.replace(/^[\-]+/,""),o-1>a&&"-"!==i[a+1][0]?(t=i[a+1],a++):t=!0,u[e]=t);return n={params:u,args:l}}}();var u,l,f,c,s,d,g;!function(){u=function(n,e){for(var t=e.split("."),r=t.length,i=-1;++i<r;){if(null==n)return null;n=n[t[i]]}return n},l=function(n,e,t){for(var r,i=e.split("."),o=i.length,a=-1;++a<o-1;)r=i[a],null==n[r]&&(n[r]={}),n=n[r];n[i[a]]=t},f=function(n,e){for(var t in e)null==n[t]&&(n[t]=e[t]);return n},c=function(n,e){for(var t in e)null!=e[t]&&(n[t]=e[t]);return n},s=function(n,e){if(null==n&&(n={}),null==e)return n;if(i(n)&&i(e)){for(var t,r=0,a=e.length;a>r;r++)t=e[r],null!=t&&n.push(o(t)?s({},t):t);return n}if(!o(e)&&!o(n))return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),n;var u,l;for(u in e)if(l=e[u],33!==u.charCodeAt(0)){if(null!=l)if(null!=n[u])if(i(l)){if(i(n[u])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",u,l,n[u]),n[u]=l;continue}s(n[u],l)}else n[u]=o(l)&&o(n[u])?s(n[u],l):l;else n[u]=l}else n[u.substring(1)]=l;return n},d=function(n,e,t){var r=u(n,e);return null==r?l(n,e,null==t?{}:t):void(typeof r!=typeof t&&logger.error("<obj_ensureProperty> type missmatch",typeof r,typeof t,(new Error).stack))},g=function(n,e){if(null!=n)if(null==e&&(e=n),i(n))for(var t=n.length;--t>-1;)g(n[t],e);else if(o(n)){var r,a;for(r in n)if(a=n[r],null!=a&&"_"!==r[0])if(o(a))g(a,e);else if("string"==typeof a){var l=a.trim();if("#["!==l.substring(0,2))continue;if(l=l.substring(2,l.length-1).trim(),n[r]=u(e,l),null==n[r]){console.warn("<config: obj_interpolate: property not exists in root",a);continue}}}}}();var h;!function(){function n(n){i(n)&&t(n),o(n)&&e(n)}function e(e){var t,i;for(t in e)i=e[t],o(i)!==!1&&(r(t)?l(t)&&s(e,i):a(i)?e[t]=c(i):n(i))}function t(e){for(var t,r,u=e.length,l=-1;++l<u;)if(t=e[l],o(t)!==!1)if(a(t)){if(r=c(t),null==r)continue;i(r)===!1&&(r=[r]),e.splice.apply(e,[l,1].concat(r)),l--,u+=r.length}else n(t)}function r(n){return 35!==n.charCodeAt(0)?!1:0===n.indexOf("#if ")}function a(n){for(var e in n)if(!r(e)&&e!==p)return!1;return!0}function l(n){var e=n.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(n){return'getter("'+n+'")'}),t=new Function("getter","return !!("+e+")");try{return t(f)}catch(r){logger.error("<config:condition-object> Evalulation error",n,r)}return!1}function f(n){var e;return e=u(g,n),null!=e?e:(e=u(d,n),null!=e?e:null)}function c(n){for(var e in n)if(e!==p&&l(e))return n[e];return n[p]}var d,g,p="default";h=function(e,t,r){d=t,g=r,n(e)}}();var p,v;!function(){function n(n){var e=process.env,r=e[n];if(null!=r)return r;switch(n){case"TEMP":r=e.TMP||e.TMPDIR;break;case"APP":r=t.env.applicationDir.toLocalDir()}return null==r&&logger.error("<config:special-folder> Not resolved",n),v(r||e.HOME||n)}var e=/^%(\w+)%/,r=/[\/]{2,}/g,i={};p=function(t){return e.test(t)===!1?t:(t=v(t).replace(e,function(e,t){return t=t.toUpperCase(),null!=i[t]?i[t]:i[t]=n(t)}).replace(r,"/"),"file://"+t)},v=function(n){return n.replace(/\\/g,"/")}}();var w;!function(){w=function(n,e){if(null!=e.config){var t=e.data.setterProperty;t&&(d(config,t,{}),n=u(config,t)),s(n,e.config)}}}();var y=function(){var n;!function(){n=function(n,e){var t={exports:{}},r=t.exports;try{new Function("module","exports",e)(t,r)}catch(i){logger.error("<config> Configuration evaluation error",n,i)}return t.exports===r&&0===Object.keys(t.exports).length&&logger.error("<config> Define `module.exports = ` in a file to export configuration",n),t.exports}}();var e;!function(){e=function(e,r,i){var o,l=new net.Uri(r);if(t.File.exists(l)&&(o=new t.File(l)),null==o&&l.isRelative()&&"undefined"!=typeof include&&(l=new net.Uri(include.location).combine(r),t.File.exists(l)&&(o=new t.File(l))),null==o)return i.optional!==!0&&logger.error("<config> Configuration file not found",r).warn("Set `optional:true`, if configuration is not strict required"),null;var f=o.read();"string"==typeof f&&(i.writable=!1,f=n(l.toLocalFile(),f));var c=i.getterProperty;return c&&(f=u(f,c)),h(f,e,a().params),f}}();var i={},l=r.Collection(Object,{Base:r.Deferred,add:function(n){return n.length&&"function"==typeof n.forEach?void n.forEach(function(n){this.push(n)},this):void this.push(n)},load:function(n,e){function t(n,e,t){return function(){w(t,e),n&&n(e,t)}}var i,o,a,u=this,l=u.length;null==e&&(e=-1);for(var f=0,c=new r.Await;++e<l;){if(i=u[e],++f>1&&i.data.sync){c.always(function(){u.load(n,e-1)});break}o=i.data&&i.data.beforeRead,a=i.data&&i.data.afterRead,o&&o(i,n),i.read(n),i.done(t(a,i,n)).always(c.delegate(null,!1))}return e>l-1&&c.always(u.resolveDelegate()),u}}),f={create:function(n){"string"==typeof n&&(n=[{path:n}]),Array.isArray(n)===!1&&(n=[n]);var e,t,r,o=n.length,a=-1,u=new l;n:for(;++a<o;)if(r=n[a],null!=r){for(t in i)if(e=i[t],e.canHandle(r)){u.add(new e(r));continue n}logger.error("<unhandled configuration source> :",r)}return u},register:function(n,e){i[n]=e}};return function(){f.register("file",r({Base:r.Deferred,Static:{canHandle:function(n){var e=n.path;return"string"!=typeof e?!1:-1!==e.search(/[\*\?]/g)?!1:"/"===e[e.length-1]?!1:!0}},Construct:function(n){this.data=n,n.path=p(n.path)},read:function(n){return this.defer(),this.config=e(n,this.data.path,this.data),this[null==this.config?"reject":"resolve"]()},write:function(n){this.data.writable===!0&&(this.config=s(this.config,n),new t.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){f.register("files",r({Base:r.Deferred,Static:{canHandle:function(n){return Array.isArray(n.files)}},Construct:function(n){var e=i.file;return n.files.map(function(n){return new e({path:n})})}}))}(),function(){f.register("directory",r({Base:r.Deferred,Static:{canHandle:function(n){var e=n.path;return"string"!=typeof e?!1:-1!==e.search(/[\*\?]/g)?!0:"/"===e[e.length-1]?!0:!1}},Construct:function(n){var e,r,i=n.path.replace(/\\/g,"/"),o=i.search(/[\*\?]/g),a=i.lastIndexOf("/",o);-1===o?e=i:(e=i.substring(0,a+1),r=i.substring(a+1));var u=new t.Directory(e).readFiles(r).files.map(function(n){return n.uri.toString()});return f.create([{files:u}]).toArray()}}))}(),function(){function n(n,e){return new(r({Base:r.Serializable,Store:r.MongoStore.Single(n),_id:e}))}f.register("mongo",r({Base:r.Deferred,Static:{canHandle:function(n){return"mongo"in n}},Construct:function(n){this.data=n,n.settings&&r.MongoStore.settings(n.settings),null==n.writable&&(n.writable=!0)},read:function(e){var t=e.mongodb;t&&r.MongoStore.settings(t);var i=this;return n(this.data.mongo).fetch().done(function(){i.config=this.toJSON(),i._id=this._id,delete i.config._id,i.resolve()}).fail(function(n){i.reject(n)}),i},write:function(n){this.config=s(this.config,n);var e=this;return r.MongoStore.resolveCollection(this.data.mongo).done(function(n){n.update({},e.config,{upsert:!0,multi:!1},function(n){return n?e.reject(n):void e.resolve()})}),e}}))}(),function(){f.register("embedded",r({Base:r.Deferred,Static:{canHandle:function(n){return o(n.config)}},Construct:function(n){this.data=n,this.data.writable=!1,this.config=n.config},read:function(){this.resolve()}}))}(),function(){f.register("custom",r({Static:{canHandle:function(n){return"function"==typeof n}},Construct:function(n){return new n}}))}(),f}(),m=r({Base:r.Deferred,Construct:function(n){this.$data=n,this.$sources=y.create(n),this.$parallelReads=new r.Await},Static:{fetch:function(n){return new m(n).$read()},create:function(n){return new m(n)}},$parallelReads:null,$sources:null,$cli:null,$get:function(n){return u(this,n)},$set:function(n,e){l(this,n,e)},$extend:function(n){s(this,n)},$read:function(n){var e=this,t=this.$parallelReads.delegate(null,!1),r=null==n?this.$sources:y.create(n);return this.$parallelReads._always=null,this.$parallelReads.always(this._onComplete),this.$cli=a(),this.defer(),r.load(e).done(function(){var n,r=e.$cli.params;for(n in r)l(e,n,r[n]);g(e),t()}),e},Self:{_onComplete:function(){this.resolve(this)}},$write:function(n){s(n);for(var e=this.$sources,t=e.length;--t>-1;)if(e[t].data.writable)return this.defer(),e[t].write(n),e[t].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return logger.error(r),this.reject(r)},Override:{toJSON:function(){var n,e=this.super();for(n in e)"$"===n[0]&&delete e[n];return e}}});return e.Config=m});