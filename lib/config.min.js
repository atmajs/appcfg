/*!
 * config v0.1.32
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
!function(e,n){"use strict";function t(){return n(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=e||i,"function"==typeof define&&define.amd?define(t):(t(),void("undefined"!=typeof module&&(module.exports=r.Config)))}(this,function(e,n){"use strict";var t,r,i,o;!function(){var n=e;null==n.Class&&e.atma&&(n=e.atma),null==n.Class&&(n=require("atma-libs/exports")),i=n.Class,r=n.net,t=e.io||require("atma-io"),o=e.logger||require("atma-logger")}();var a,u;!function(){a=function(e){return null!=e&&"number"==typeof e.length&&"function"==typeof e.splice},u=function(e){return null!=e&&"object"==typeof e}}();var f;!function(){var e;f=function(){if(null!=e)return e;for(var n,t,r,i=process.argv,o=i.length,a=2,u={},f=[];o>a;a++)r=i[a],"-"!==r[0]?f.push(r):(n=r.replace(/^[\-]+/,""),o-1>a&&"-"!==i[a+1][0]?(t=i[a+1],a++):t=!0,c(u,n,t));return e={params:u,args:f}}}();var l,c,s,d,g,h,p;!function(){l=function(e,n){for(var t=n.split("."),r=t.length,i=-1;++i<r;){if(null==e)return null;e=e[t[i]]}return e},c=function(e,n,t){for(var r,i=n.split("."),o=i.length,a=-1;++a<o-1;)r=i[a],null==e[r]&&(e[r]={}),e=e[r];e[i[a]]=t},s=function(e,n){for(var t in n)null==e[t]&&(e[t]=n[t]);return e},d=function(e,n){for(var t in n)null!=n[t]&&(e[t]=n[t]);return e},g=function(e,n){if(null==e&&(e={}),null==n)return e;if(a(e)&&a(n)){for(var t,r=0,i=n.length;i>r;r++)t=n[r],null!=t&&e.push(u(t)?g({},t):t);return e}if(!u(n)&&!u(e))return o.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),e;var f,l;for(f in n)if(l=n[f],33!==f.charCodeAt(0)){if(null!=l)if(null!=e[f])if(a(l)){if(a(e[f])===!1){o.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",f,l,e[f]),e[f]=l;continue}g(e[f],l)}else e[f]=u(l)&&u(e[f])?g(e[f],l):l;else e[f]=l}else e[f.substring(1)]=l;return e},h=function(e,n,t){var r=l(e,n);return null==r?c(e,n,null==t?{}:t):void(typeof r!=typeof t&&o.error("<obj_ensureProperty> type missmatch",typeof r,typeof t,(new Error).stack))},p=function(e,n){if(null!=e)if(null==n&&(n=e),a(e))for(var t=e.length;--t>-1;)p(e[t],n);else if(u(e)){var r,i;for(r in e)if(i=e[r],null!=i&&"_"!==r[0])if(u(i))p(i,n);else if("string"==typeof i){var o=i.trim();if("#["!==o.substring(0,2))continue;if(o=o.substring(2,o.length-1).trim(),e[r]=l(n,o),null==e[r]){console.warn("<config: obj_interpolate: property not exists in root",i);continue}}}}}();var v,w;!function(){function e(e){var n=process.env,r=n[e];if(null!=r)return r;switch(e){case"TEMP":r=n.TMP||n.TMPDIR;break;case"APP":r=t.env.applicationDir.toLocalDir();break;case"APPDATA":r=n.HOME}return null==r&&o.error("<config:special-folder> Not resolved",e),w(r||n.HOME||e)}var n=/^%(\w+)%/,r=/[\/]{2,}/g,i={};v=function(t){return n.test(t)===!1?t:(t=w(t).replace(n,function(n,t){return t=t.toUpperCase(),null!=i[t]?i[t]:i[t]=e(t)}).replace(r,"/"),"file://"+t)},w=function(e){return e.replace(/\\/g,"/")}}();var y;!function(){y=function(e,n){if(null!=n.config){var t=n.data.setterProperty;t&&(h(config,t,{}),e=l(config,t)),g(e,n.config)}}}();var b;!function(){function e(e){a(e)&&t(e),u(e)&&n(e)}function n(n){var t,o,a;for(t in n)a=t.charCodeAt(0),36!==a&&(o=n[t],u(o)!==!1&&(r(t)?f(t)&&g(n,o):i(o)?n[t]=s(o):e(o)))}function t(n){for(var t,r,o=n.length,f=-1;++f<o;)if(t=n[f],u(t)!==!1)if(i(t)){if(r=s(t),null==r)continue;a(r)===!1&&(r=[r]),n.splice.apply(n,[f,1].concat(r)),f--,o+=r.length}else e(t)}function r(e){return 35!==e.charCodeAt(0)?!1:0===e.indexOf("#if ")}function i(e){var n=!1;for(var t in e)if(r(t))n=!0;else if(t!==v)return!1;return n===!0}function f(e){var n=e.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(e,n,t){return d(t,n)?e:"."===t[n-1]?e:'getter("'+e+'")'}),t=new Function("getter","return !!("+n+")");try{return t(c)}catch(r){o.error("<config:condition-object> Evalulation error",e,r)}return!1}function c(e){var n=l(p,e);if(null!=n)return n;if(n=l(h,e),null!=n)return n;if("undefined"!=typeof process){var t=process.env;if(n=t[e],null!=n)return n;if(n=t["NODE_"+e],null!=n)return n;var r=t.NODE_ENV||t.ENV;if(null!=r&&r.toUpperCase()===e.toUpperCase())return!0}return null}function s(e){for(var n in e)if(n!==v&&f(n))return e[n];return e[v]}function d(e,n){for(var t,r=!1,i=!1;--n>-1;){if(t=e.charCodeAt(n),34===t){if(i)continue;if(r&&"\\"===e[n-1])continue;r=!r}if(39===t){if(r)continue;if(i&&"\\"===e[n-1])continue;i=!i}}return i||r}b=function(n,t,r){h=t,p=r,e(n)};var h,p,v="default"}();var m=function(){var e;!function(){e=function(e,n){var t={exports:{}},r=t.exports;try{new Function("module","exports",n)(t,r)}catch(i){o.error("<config> Configuration evaluation error",e,i)}return t.exports===r&&0===Object.keys(t.exports).length&&o.error("<config> Define `module.exports = ` in a file to export configuration",e),t.exports}}();var n,a;!function(){function u(e,n,i){var a=new r.Uri(n);return t.File.exists(a)?new t.File(a):a.isRelative()&&"undefined"!=typeof include&&(a=new r.Uri(include.location).combine(n),t.File.exists(a))?new t.File(a):(i!==!0&&o.error("<config> Configuration file not found",n).warn("Set `optional:true`, if configuration is not strict required"),null)}a=function(n,t,r){var o=new i.Deferred,a=u(n,t,r.optional);return null==a?o.reject({code:404}):(a.readAsync().fail(o.rejectDelegate()).done(function(n){"string"==typeof n&&(r.writable=!1,n=e(a.uri.toLocalFile(),n));var t=r.getterProperty;t&&(n=l(n,t)),o.resolve(n)}),o)},n=function(n,t,r){var i=u(n,t,r.optional);if(null==i)return null;var o=i.read();"string"==typeof o&&(r.writable=!1,o=e(i.uri.toLocalFile(),o));var a=r.getterProperty;return a&&(o=l(o,a)),o}}();var f={},c=i.Collection(Object,{Base:i.Deferred,add:function(e){return e.length&&"function"==typeof e.forEach?void e.forEach(function(e){this.push(e)},this):void this.push(e)},load:function(e,n){function t(e,n,t){return function(){y(t,n),e&&e(n,t)}}var r,o,a,u=this,f=u.length;null==n&&(n=-1);for(var l=0,c=new i.Await;++n<f;){if(r=u[n],++l>1&&r.data.sync){c.always(function(){u.load(e,n-1)});break}o=r.data&&r.data.beforeRead,a=r.data&&r.data.afterRead,o&&o(r,e),r.read(e),r.done(t(a,r,e)).always(c.delegate(null,!1))}return n>f-1&&c.always(u.resolveDelegate()),u}}),s={create:function(e){"string"==typeof e&&(e=[{path:e}]),Array.isArray(e)===!1&&(e=[e]);var n,t,r,i=e.length,a=-1,u=new c;e:for(;++a<i;)if(r=e[a],null!=r){for(t in f)if(n=f[t],n.canHandle(r)){u.add(new n(r));continue e}o.error("<unhandled configuration source> :",r)}return u},register:function(e,n){f[e]=n}};return function(){s.register("file",i({Base:i.Deferred,Static:{canHandle:function(e){var n=e.path;return"string"!=typeof n?!1:-1!==n.search(/[\*\?]/g)?!1:"/"===n[n.length-1]?!1:!0}},Construct:function(e){this.data=e,e.path=v(e.path)},read:function(e){this.defer();var n=this;return a(e,this.data.path,this.data).fail(this.rejectDelegate()).done(function(e){n.config=e,n.resolve(e)}),this},write:function(e){if(this.defer(),this.data.writable!==!0)return this.reject("Not writable");this.config=g(this.config,e);try{t.File.writeAsync(this.data.path,JSON.stringify(this.config)).pipe(this)}catch(n){this.reject("JSON.serialization "+String(n))}return this}}))}(),function(){s.register("files",i({Base:i.Deferred,Static:{canHandle:function(e){return Array.isArray(e.files)}},Construct:function(e){var n=f.file;return e.files.map(function(e){return new n({path:e})})}}))}(),function(){s.register("directory",i({Base:i.Deferred,Static:{canHandle:function(e){var n=e.path;return"string"!=typeof n?!1:-1!==n.search(/[\*\?]/g)?!0:"/"===n[n.length-1]?!0:!1}},Construct:function(e){var n,r,i=e.path.replace(/\\/g,"/"),o=i.search(/[\*\?]/g),a=i.lastIndexOf("/",o);-1===o?n=i:(n=i.substring(0,a+1),r=i.substring(a+1));var u=new t.Directory(n).readFiles(r).files.map(function(e){return e.uri.toString()});return s.create([{files:u}]).toArray()}}))}(),function(){function e(e,n){return new(i({Base:i.Serializable,Store:i.MongoStore.Single(e),_id:n}))}s.register("mongo",i({Base:i.Deferred,Static:{canHandle:function(e){return"mongo"in e}},Construct:function(e){this.data=e,e.settings&&i.MongoStore.settings(e.settings),null==e.writable&&(e.writable=!0)},read:function(n){var t=n.mongodb;t&&i.MongoStore.settings(t);var r=this;return e(this.data.mongo).fetch().done(function(){r.config=this.toJSON(),r._id=this._id,delete r.config._id,r.resolve()}).fail(function(e){r.reject(e)}),r},write:function(e){this.config=g(this.config,e);var n=this;return i.MongoStore.resolveCollection(this.data.mongo).done(function(e){e.update({},n.config,{upsert:!0,multi:!1},function(e){return e?n.reject(e):void n.resolve()})}),n}}))}(),function(){s.register("embedded",i({Base:i.Deferred,Static:{canHandle:function(e){return u(e.config)}},Construct:function(e){this.data=e,this.data.writable=!1,this.config=e.config},read:function(){this.resolve()}}))}(),function(){s.register("custom",i({Static:{canHandle:function(e){return"function"==typeof e}},Construct:function(e){return new e}}))}(),s}(),C=i({Base:i.Deferred,Construct:function(e){this.$data=e,this.$sources=m.create(e),this.$parallelReads=new i.Await},Static:{fetch:function(e){return new C(e).$read()},create:function(e){return new C(e)}},$parallelReads:null,$sources:null,$cli:null,$get:function(e){return l(this,e)},$set:function(e,n){c(this,e,n)},$extend:function(e){g(this,e)},$read:function(e){var n=this,t=this.$parallelReads.delegate(null,!1),r=null==e?this.$sources:m.create(e);return this.$parallelReads._always=null,this.$parallelReads.always(this._onComplete),this.$cli=f(),this.defer(),r.load(n).done(function(){var e,r=n.$cli.params;for(e in r)c(n,e,r[e]);p(n),b(n,n,n.$cli.params),t()}),n},Self:{_onComplete:function(){this.resolve(this)}},$write:function(e){g(e);for(var n=this.$sources,t=n.length;--t>-1;)if(n[t].data.writable)return this.defer(),n[t].write(e),n[t].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return o.error(r),this.reject(r)},Override:{toJSON:function(){var e,n=this.super();for(e in n)"$"===e[0]&&delete n[e];return n}}});return n.Config=C});