/*!
 * config v0.1.9
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
(function(e,t){"use strict";function r(){return t(o,n)}var n,o="undefined"==typeof window||null==window.navigator?global:window;return n=e||o,"function"==typeof define&&define.amd?define(r):(r(),"undefined"!=typeof module&&(module.exports=n.Config),void 0)})(this,function(global,exports){"use strict";var io,Class;(function(){Class=global.atma&&global.atma.Class||global.Class||require("atma-libs/exports").Class,io=global.io||require("atma-io")})();var is_Array,is_Object;(function(){is_Array=function(e){return null!=e&&"number"==typeof e.length&&"function"==typeof e.splice},is_Object=function(e){return null!=e&&"object"==typeof e}})();var cli_arguments;(function(){cli_arguments=function(){for(var e,t,r,n=process.argv,o=n.length,i=2,a={},s=[];o>i;i++)r=n[i],"-"!==r[0]?s.push(r):(e=r.replace(/^[\-]+/,""),o-1>i&&"-"!==n[i+1][0]?(t=n[i+1],i++):t=!0,a[e]=t);return{params:a,args:s}}})();var obj_getProperty,obj_setProperty,obj_defaults,obj_extend,obj_deepExtend,obj_ensureProperty,obj_interpolate;(function(){obj_getProperty=function(e,t){for(var r=t.split("."),n=r.length,o=-1;n>++o;){if(null==e)return null;e=e[r[o]]}return e},obj_setProperty=function(e,t,r){for(var n,o=t.split("."),i=o.length,a=-1;i-1>++a;)n=o[a],null==e[n]&&(e[n]={}),e=e[n];e[o[a]]=r},obj_defaults=function(e,t){for(var r in t)null==e[r]&&(e[r]=t[r]);return e},obj_extend=function(e,t){for(var r in t)null!=t[r]&&(e[r]=t[r]);return e},obj_deepExtend=function(e,t){if(null==e&&(e={}),null==t)return e;if(is_Array(e)&&is_Array(t)){for(var r,n=0,o=t.length;o>n;n++)r=t[n],is_Object(r)?e.push(obj_deepExtend({},r)):e.push(r);return e}if(!is_Object(t)&&!is_Object(e))return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),e;var i,a;for(i in t)if(a=t[i],33!==i.charCodeAt(0))if(null!=e[i])if(is_Array(a)){if(is_Array(e[i])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",i,a,e[i]),e[i]=a;continue}obj_deepExtend(e[i],a)}else e[i]=is_Object(a)&&is_Object(e[i])?obj_deepExtend(e[i],a):a;else e[i]=a;else e[i.substring(1)]=a;return e},obj_ensureProperty=function(e,t,r){var n=obj_getProperty(e,t);return null==n?obj_setProperty(e,t,null==r?{}:r):(typeof n!=typeof r&&logger.error("<obj_ensureProperty> type missmatch",typeof n,typeof r,Error().stack),void 0)},obj_interpolate=function(e,t){if(null!=e)if(null==t&&(t=e),is_Array(e))for(var r=e.length;--r>-1;)obj_interpolate(e[r],t);else if(is_Object(e)){var n,o;for(n in e)if(o=e[n],null!=o)if(is_Object(o))obj_interpolate(o,t);else if("string"==typeof o){var i=o.trim();if("#["!==i.substring(0,2))continue;if(i=i.substring(2,i.length-1).trim(),e[n]=obj_getProperty(t,i),null==e[n]){console.warn("<config: obj_interpolate: property not exists in root",o);continue}}}}})();var obj_conditions;(function(){function e(e){is_Array(e)&&r(e),is_Object(e)&&t(e)}function t(t){var r,a;for(r in t)a=t[r],is_Object(a)!==!1&&(n(r)?i(r)&&obj_deepExtend(t,a):o(a)?t[r]=s(a):e(a))}function r(t){for(var r,n,i=t.length,a=-1;i>++a;)if(r=t[a],is_Object(r)!==!1)if(o(r)){if(n=s(r),null==n)continue;is_Array(n)===!1&&(n=[n]),t.splice.apply(t,[a,1].concat(n)),a--,i+=n.length}else e(r)}function n(e){return 35!==e.charCodeAt(0)?!1:0===e.indexOf("#if ")}function o(e){for(var t in e)if(!n(t)&&t!==u)return!1;return!0}function i(e){var t=e.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(e){return'getter("'+e+'")'}),r=Function("getter","return !!("+t+")");try{return r(a)}catch(n){logger.error("<config:condition-object> Evalulation error",e,n)}return!1}function a(e){var t;return t=obj_getProperty(l,e),null!=t?t:(t=obj_getProperty(c,e),null!=t?t:null)}function s(e){for(var t in e)if(t!==u&&i(t))return e[t];return e[u]}var c,l,u="default";obj_conditions=function(t,r,n){c=r,l=n,e(t)}})();var path_handleSpecialFolder,path_normalize;(function(){function e(e){var t=process.env,r=t[e];if(null!=r)return r;switch(e){case"TEMP":r=t.TMP||t.TMPDIR;break;case"APP":r=io.env.applicationDir.toLocalDir()}return null==r&&logger.error("<config:special-folder> Not resolved",e),path_normalize(r||t.HOME||e)}var t=/%([^%]+)%/g,r=/[\/]{2,}/g,n={};path_handleSpecialFolder=function(o){return t.test(o)===!1?o:path_normalize(o).replace(t,function(t,r){return r=r.toUpperCase(),null!=n[r]?n[r]:n[r]=e(r)}).replace(r,"/")},path_normalize=function(e){return e.replace(/\\/g,"/")}})();var cfg_merge;(function(){cfg_merge=function(e,t){if(null!=t.config){var r=t.data.setterProperty;r&&(obj_ensureProperty(config,r,{}),e=obj_getProperty(config,r)),obj_deepExtend(e,t.config)}}})();var SourceFactory=function(){var Handlers={},Sources=Class.Collection(Object,{Base:Class.Deferred,add:function(e){return e.length&&"function"==typeof e.forEach?(e.forEach(function(e){this.push(e)},this),void 0):(this.push(e),void 0)},load:function(e,t){function r(e,t,r){return function(){cfg_merge(r,t),e&&e(t,r)}}var n,o,i,a=this,s=a.length;null==t&&(t=-1);for(var c=0,l=new Class.Await;s>++t;){if(n=a[t],++c>1&&n.data.sync){l.always(function(){a.load(e,t-1)});break}o=n.data&&n.data.beforeRead,i=n.data&&n.data.afterRead,o&&o(n,e),n.read(e),n.done(r(i,n,e)).always(l.delegate(null,!1))}return t>s-1&&l.always(a.resolveDelegate()),a}}),SourceFactory={create:function(e){var t,r,n,o=e.length,i=-1,a=new Sources;e:for(;o>++i;){n=e[i];for(r in Handlers)if(t=Handlers[r],t.canHandle(n)){a.add(new t(n));continue e}logger.error("<unhandled configuration source> :",n)}return a},register:function(e,t){Handlers[e]=t}};return function(){function module_eval(path,script){var module={exports:{}},exports=module.exports;try{eval(script)}catch(error){console.error("<config> Configuration evaluation error",path,error)}return 0===Object.keys(module.exports).length&&logger.error("<config> Define `module.exports = ` in a file to export configuration",path).log(" - (`global.config = ` support is removed)".yellow),module.exports}SourceFactory.register("file",Class({Base:Class.Deferred,Static:{canHandle:function(e){var t=e.path;return"string"!=typeof t?!1:-1!==t.search(/\*\?/g)?!1:"/"===t[t.length-1]?!1:!0}},Construct:function(e){this.data=e,e.path=path_handleSpecialFolder(e.path)},read:function(e){this.defer();var t=new io.File(this.data.path);if(t.exists()===!1)return this.data.optional?this.resolve():(console.error("<config> Configuration file not found",this.data.path),this.reject());this.config=t.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var r=this.data.getterProperty;return r&&(this.config=obj_getProperty(this.config,r)),obj_conditions(this.config,e,cli_arguments().params),this.resolve()},write:function(e){this.data.writable===!0&&(this.config=obj_deepExtend(this.config,e),new io.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){SourceFactory.register("directory",Class({Base:Class.Deferred,Static:{canHandle:function(e){var t=e.path;return"string"!=typeof t?!1:-1!==t.search(/\*\?/g)?!0:"/"===t[t.length-1]?!0:!1}},Construct:function(e){var t,r,n=e.path.replace(/\\/g,"/"),o=n.search(/\*\?/g),i=n.lastIndexOf("/",o);return-1===o?t=n:(t=n.substring(0,i),r=n.substring(i+1)),new io.Directory(t).readFiles(r).files.map(function(e){return e.uri.toLocalFile()})}}))}(),function(){function e(e,t){return new(Class({Base:Class.Serializable,Store:Class.MongoStore.Single(e),_id:t}))}SourceFactory.register("mongo",Class({Base:Class.Deferred,Static:{canHandle:function(e){return"mongo"in e}},Construct:function(e){this.data=e,e.settings&&Class.MongoStore.settings(e.settings),null==e.writable&&(e.writable=!0)},read:function(t){var r=t.mongodb;r&&Class.MongoStore.settings(r);var n=this;return e(this.data.mongo).fetch().done(function(){n.config=this.toJSON(),n._id=this._id,delete n.config._id,n.resolve()}).fail(function(e){n.reject(e)}),n},write:function(e){this.config=obj_deepExtend(this.config,e);var t=this;return Class.MongoStore.resolveCollection(this.data.mongo).done(function(e){e.update({},t.config,{upsert:!0,multi:!1},function(e){return e?t.reject(e):(t.resolve(),void 0)})}),t}}))}(),function(){SourceFactory.register("embedded",Class({Base:Class.Deferred,Static:{canHandle:function(e){return is_Object(e.config)}},Construct:function(e){this.data=e,this.data.writable=!1,this.config=e.config},read:function(){this.resolve()}}))}(),function(){SourceFactory.register("custom",Class({Static:{canHandle:function(e){return"function"==typeof e}},Construct:function(e){return new e}}))}(),SourceFactory}(),Config=Class({Base:Class.Deferred,Construct:function(e){this.$data=e,this.$sources=SourceFactory.create(e)},Static:{fetch:function(e){return new Config(e).$read()},create:function(e){return new Config(e)}},$read:function(e){e=e||this.$data;var t=this;return this.defer(),this.$cli=cli_arguments(),this.$sources.load(t).done(function(){var e,r=t.$cli.params;for(e in r)obj_setProperty(t,e,r[e]);obj_interpolate(t),t.resolve()}),t},$write:function(e){obj_deepExtend(e);for(var t=this.$sources,r=t.length;--r>-1;)if(t[r].data.writable)return this.defer(),t[r].write(e),t.always(this.resolveDelegate()),this;var n="<config:write> Writable source not defined.";return logger.error(n),this.reject(n)},$extend:function(e){obj_deepExtend(this,e)},Override:{toJSON:function(){var e,t=this.super();for(e in t)"$"===e[0]&&delete t[e];return t}}});return exports.Config=Config});