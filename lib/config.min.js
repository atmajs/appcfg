/*!
 * config v0.0.1
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
(function(e,t){"use strict";function r(){return t(o,n)}var n,o="undefined"==typeof window||null==window.navigator?global:window;return n=e||o,"function"==typeof define&&define.amd?define(r):(r(),"undefined"!=typeof module&&(module.exports=n.Config),void 0)})(this,function(global,exports){"use strict";var io,Class;(function(){Class=global.atma&&global.atma.Class||global.Class,io=global.io||require("atma-io")})();var cli_arguments;(function(){cli_arguments=function(){for(var e,t,r,n=process.argv,o=n.length,a=2,i={},s=[];o>a;a++)r=n[a],"-"!==r[0]?s.push(r):(e=r.replace(/^[\-]+/,""),o-1>a&&"-"!==n[a+1][0]?(t=n[a+1],a++):t=!0,i[e]=t);return{params:i,args:s}}})();var obj_getProperty,obj_setProperty,obj_defaults,obj_extend,obj_deepExtend,obj_ensureProperty;(function(){obj_getProperty=function(e,t){for(var r=t.split("."),n=r.length,o=-1;n>++o;){if(null==e)return null;e=e[r[o]]}return e},obj_setProperty=function(e,t,r){for(var n,o=t.split("."),a=o.length,i=-1;a-1>++i;)n=o[i],null==e[n]&&(e[n]={}),e=e[n];e[o[i]]=r},obj_defaults=function(e,t){for(var r in t)null==e[r]&&(e[r]=t[r]);return e},obj_extend=function(e,t){for(var r in t)null!=t[r]&&(e[r]=t[r]);return e},obj_deepExtend=function(e,t){if(null==t)return e;if(Array.isArray(e)&&Array.isArray(t)){for(var r,n=0,o=t.length;o>n;n++)r=t[n],-1===e.indexOf(r)&&e.push(r);return e}if("object"!=typeof t&&"object"!=typeof e)return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),e;var a,i;for(a in t)if(i=t[a],null!=e[a])if(Array.isArray(i)){if(Array.isArray(e[a])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",a,i,e[a]),e[a]=i;continue}obj_deepExtend(e[a],i)}else e[a]="object"!=typeof i||"object"!=typeof e[a]?i:obj_deepExtend(e[a],i);else e[a]=i;return e},obj_ensureProperty=function(e,t,r){var n=obj_getProperty(e,t);return null==n?obj_setProperty(e,t,null==r?{}:r):(typeof n!=typeof r&&logger.error("<obj_ensureProperty> type missmatch",typeof n,typeof r,Error().stack),void 0)}})();var path_handleSpecialFolder,path_normalize;(function(){function e(e){var t=process.env,r=t[e];if(null!=r)return r;switch(e){case"TEMP":r=t.TMP||t.TMPDIR}return null!=r?r:(logger.error("<config:special-folder> Not resolved",e),t.HOME||e)}var t=/%([^%]+)%/g,r=/[\/]{2,}/g,n={};path_handleSpecialFolder=function(o){return t.test(o)===!1?o:path_normalize(o).replace(t,function(t,r){return r=r.toUpperCase(),null!=n[r]?n[r]:n[r]=e(r)}).replace(r,"/")}})();var SourceFactory=function(){var Handlers={},Sources=Class.Collection(Object,{Base:Class.Await,add:function(e){return e.length&&"function"==typeof e.forEach?(e.forEach(function(e){this.push(e)},this),void 0):(this.push(e),void 0)}}),SourceFactory={loadSources:function(e){var t,r,n,o=e.length,a=-1,i=new Sources;e:for(;o>++a;){n=e[a];for(r in Handlers)if(t=Handlers[r],t.canHandle(n)){i.add(new t(n));continue e}logger.error("<unhandled configuration source> :",n)}for(a=i.length;--a>-1;)i[a].read().always(i.delegate(null,!1));return i},register:function(e,t){Handlers[e]=t}};return function(){function module_eval(path,script){var module={exports:{}},exports=module.exports;try{eval(script)}catch(error){console.error("<config> Configuration evaluation error",path,error)}return module.exports}SourceFactory.register("file",Class({Base:Class.Deferred,Static:{canHandle:function(e){var t=e.path;return"string"!=typeof t?!1:-1!==t.search(/\*\?/g)?!1:"/"===t[t.length-1]?!1:!0}},Construct:function(e){this.data=e,e.path=path_handleSpecialFolder(e.path)},read:function(){this.defer();var e=new io.File(this.data.path);if(e.exists()===!1)return console.error("<config> Configuration file not found",this.data.path),this.reject();this.config=e.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var t=this.data.getterProperty;return t&&(this.config=obj_getProperty(this.config,t)),this.resolve()},write:function(){this.data.writable===!0&&new io.File(this.data.path).write(this.config)}}))}(),function(){SourceFactory.register("directory",Class({Base:Class.Deferred,Static:{canHandle:function(e){var t=e.path;return"string"!=typeof t?!1:-1!==t.search(/\*\?/g)?!0:"/"===t[t.length-1]?!0:!1}},Construct:function(e){var t,r,n=e.path.replace(/\\/g,"/"),o=n.search(/\*\?/g),a=n.lastIndexOf("/",o);return-1===o?t=n:(t=n.substring(0,a),r=n.substring(a+1)),new io.Directory(t).readFiles(r).files.map(function(e){return e.uri.toLocalFile()})}}))}(),function(){var e={read:function(){return this.fetch()},write:function(e){this.data.writable===!0&&(obj_deepExtend(this,e),this.save())}};SourceFactory.register("mongo",Class({Static:{canHandle:function(e){return"mongo"in e}},Construct:function(t){new(Class({Base:e,Store:Class.MongoStore.Single(t.mongo)}))}}))}(),SourceFactory}(),SourceFactory=function(){var Handlers={},Sources=Class.Collection(Object,{Base:Class.Await,add:function(e){return e.length&&"function"==typeof e.forEach?(e.forEach(function(e){this.push(e)},this),void 0):(this.push(e),void 0)}}),SourceFactory={loadSources:function(e){var t,r,n,o=e.length,a=-1,i=new Sources;e:for(;o>++a;){n=e[a];for(r in Handlers)if(t=Handlers[r],t.canHandle(n)){i.add(new t(n));continue e}logger.error("<unhandled configuration source> :",n)}for(a=i.length;--a>-1;)i[a].read().always(i.delegate(null,!1));return i},register:function(e,t){Handlers[e]=t}};return function(){function module_eval(path,script){var module={exports:{}},exports=module.exports;try{eval(script)}catch(error){console.error("<config> Configuration evaluation error",path,error)}return module.exports}SourceFactory.register("file",Class({Base:Class.Deferred,Static:{canHandle:function(e){var t=e.path;return"string"!=typeof t?!1:-1!==t.search(/\*\?/g)?!1:"/"===t[t.length-1]?!1:!0}},Construct:function(e){this.data=e,e.path=path_handleSpecialFolder(e.path)},read:function(){this.defer();var e=new io.File(this.data.path);if(e.exists()===!1)return console.error("<config> Configuration file not found",this.data.path),this.reject();this.config=e.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var t=this.data.getterProperty;return t&&(this.config=obj_getProperty(this.config,t)),this.resolve()},write:function(){this.data.writable===!0&&new io.File(this.data.path).write(this.config)}}))}(),function(){SourceFactory.register("directory",Class({Base:Class.Deferred,Static:{canHandle:function(e){var t=e.path;return"string"!=typeof t?!1:-1!==t.search(/\*\?/g)?!0:"/"===t[t.length-1]?!0:!1}},Construct:function(e){var t,r,n=e.path.replace(/\\/g,"/"),o=n.search(/\*\?/g),a=n.lastIndexOf("/",o);return-1===o?t=n:(t=n.substring(0,a),r=n.substring(a+1)),new io.Directory(t).readFiles(r).files.map(function(e){return e.uri.toLocalFile()})}}))}(),function(){var e={read:function(){return this.fetch()},write:function(e){this.data.writable===!0&&(obj_deepExtend(this,e),this.save())}};SourceFactory.register("mongo",Class({Static:{canHandle:function(e){return"mongo"in e}},Construct:function(t){new(Class({Base:e,Store:Class.MongoStore.Single(t.mongo)}))}}))}(),SourceFactory}(),Config=Class({Base:Class.Deferred,Construct:function(e){this.data=e},Static:{fetch:function(e){return new Config(e).$read()}},$read:function(){var e=this,t=this.data;return this._sources=SourceFactory.loadSources(t).done(function(){this.each(function(t){var r=e,n=t.data.setterProperty;n&&(obj_ensureProperty(e,n,{}),r=obj_getProperty(e,n)),obj_deepExtend(r,t.config)}),e.$cli=cli_arguments();var t,r=e.$cli.params;for(t in r)obj_setProperty(e,t,r[t]);e.resolve()}),e},$write:function(e){obj_deepExtend(e);for(var t=this._sources,r=t.length;--r>-1;)if(t[r].data.writable)return t[r].write(e),this;return logger.error("<config:write> Writable source not defined."),this}});return exports.Config=Config});