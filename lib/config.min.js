/*!
 * config v0.1.13
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
(function(t,n){"use strict";function e(){return n(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=t||i,"function"==typeof define&&define.amd?define(e):(e(),"undefined"!=typeof module&&(module.exports=r.Config),void 0)})(this,function(t,n){"use strict";var e,r;(function(){r=t.atma&&t.atma.Class||t.Class||require("atma-libs/exports").Class,e=t.io||require("atma-io")})();var i,o;(function(){i=function(t){return null!=t&&"number"==typeof t.length&&"function"==typeof t.splice},o=function(t){return null!=t&&"object"==typeof t}})();var a;(function(){a=function(){for(var t,n,e,r=process.argv,i=r.length,o=2,a={},f=[];i>o;o++)e=r[o],"-"!==e[0]?f.push(e):(t=e.replace(/^[\-]+/,""),i-1>o&&"-"!==r[o+1][0]?(n=r[o+1],o++):n=!0,a[t]=n);return{params:a,args:f}}})();var f,s,u,c,l,g,h;(function(){f=function(t,n){for(var e=n.split("."),r=e.length,i=-1;r>++i;){if(null==t)return null;t=t[e[i]]}return t},s=function(t,n,e){for(var r,i=n.split("."),o=i.length,a=-1;o-1>++a;)r=i[a],null==t[r]&&(t[r]={}),t=t[r];t[i[a]]=e},u=function(t,n){for(var e in n)null==t[e]&&(t[e]=n[e]);return t},c=function(t,n){for(var e in n)null!=n[e]&&(t[e]=n[e]);return t},l=function(t,n){if(null==t&&(t={}),null==n)return t;if(i(t)&&i(n)){for(var e,r=0,a=n.length;a>r;r++)e=n[r],o(e)?t.push(l({},e)):t.push(e);return t}if(!o(n)&&!o(t))return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),t;var f,s;for(f in n)if(s=n[f],33!==f.charCodeAt(0))if(null!=t[f])if(i(s)){if(i(t[f])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",f,s,t[f]),t[f]=s;continue}l(t[f],s)}else t[f]=o(s)&&o(t[f])?l(t[f],s):s;else t[f]=s;else t[f.substring(1)]=s;return t},g=function(t,n,e){var r=f(t,n);return null==r?s(t,n,null==e?{}:e):(typeof r!=typeof e&&logger.error("<obj_ensureProperty> type missmatch",typeof r,typeof e,Error().stack),void 0)},h=function(t,n){if(null!=t)if(null==n&&(n=t),i(t))for(var e=t.length;--e>-1;)h(t[e],n);else if(o(t)){var r,a;for(r in t)if(a=t[r],null!=a)if(o(a))h(a,n);else if("string"==typeof a){var s=a.trim();if("#["!==s.substring(0,2))continue;if(s=s.substring(2,s.length-1).trim(),t[r]=f(n,s),null==t[r]){console.warn("<config: obj_interpolate: property not exists in root",a);continue}}}}})();var d;(function(){function t(t){i(t)&&e(t),o(t)&&n(t)}function n(n){var e,i;for(e in n)i=n[e],o(i)!==!1&&(r(e)?s(e)&&l(n,i):a(i)?n[e]=c(i):t(i))}function e(n){for(var e,r,f=n.length,s=-1;f>++s;)if(e=n[s],o(e)!==!1)if(a(e)){if(r=c(e),null==r)continue;i(r)===!1&&(r=[r]),n.splice.apply(n,[s,1].concat(r)),s--,f+=r.length}else t(e)}function r(t){return 35!==t.charCodeAt(0)?!1:0===t.indexOf("#if ")}function a(t){for(var n in t)if(!r(n)&&n!==p)return!1;return!0}function s(t){var n=t.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(t){return'getter("'+t+'")'}),e=Function("getter","return !!("+n+")");try{return e(u)}catch(r){logger.error("<config:condition-object> Evalulation error",t,r)}return!1}function u(t){var n;return n=f(h,t),null!=n?n:(n=f(g,t),null!=n?n:null)}function c(t){for(var n in t)if(n!==p&&s(n))return t[n];return t[p]}var g,h,p="default";d=function(n,e,r){g=e,h=r,t(n)}})();var p,v;(function(){function t(t){var n=process.env,r=n[t];if(null!=r)return r;switch(t){case"TEMP":r=n.TMP||n.TMPDIR;break;case"APP":r=e.env.applicationDir.toLocalDir()}return null==r&&logger.error("<config:special-folder> Not resolved",t),v(r||n.HOME||t)}var n=/%([^%]+)%/g,r=/[\/]{2,}/g,i={};p=function(e){return n.test(e)===!1?e:v(e).replace(n,function(n,e){return e=e.toUpperCase(),null!=i[e]?i[e]:i[e]=t(e)}).replace(r,"/")},v=function(t){return t.replace(/\\/g,"/")}})();var w;(function(){w=function(t,n){if(null!=n.config){var e=n.data.setterProperty;e&&(g(config,e,{}),t=f(config,e)),l(t,n.config)}}})();var y=function(){var t={},n=r.Collection(Object,{Base:r.Deferred,add:function(t){return t.length&&"function"==typeof t.forEach?(t.forEach(function(t){this.push(t)},this),void 0):(this.push(t),void 0)},load:function(t,n){function e(t,n,e){return function(){w(e,n),t&&t(n,e)}}var i,o,a,f=this,s=f.length;null==n&&(n=-1);for(var u=0,c=new r.Await;s>++n;){if(i=f[n],++u>1&&i.data.sync){c.always(function(){f.load(t,n-1)});break}o=i.data&&i.data.beforeRead,a=i.data&&i.data.afterRead,o&&o(i,t),i.read(t),i.done(e(a,i,t)).always(c.delegate(null,!1))}return n>s-1&&c.always(f.resolveDelegate()),f}}),i={create:function(e){var r,i,o,a=e.length,f=-1,s=new n;t:for(;a>++f;)if(o=e[f],null!=o){for(i in t)if(r=t[i],r.canHandle(o)){s.add(new r(o));continue t}logger.error("<unhandled configuration source> :",o)}return s},register:function(n,e){t[n]=e}};return function(){function t(t,n){var e={exports:{}},r=e.exports;try{Function("module","exports",n)(e,r)}catch(i){console.error("<config> Configuration evaluation error",t,i)}return 0===Object.keys(e.exports).length&&logger.error("<config> Define `module.exports = ` in a file to export configuration",t).log(" - (`global.config = ` support is removed)".yellow),e.exports}i.register("file",r({Base:r.Deferred,Static:{canHandle:function(t){var n=t.path;return"string"!=typeof n?!1:-1!==n.search(/[\*\?]/g)?!1:"/"===n[n.length-1]?!1:!0}},Construct:function(t){this.data=t,t.path=p(t.path)},read:function(n){this.defer();var r=new e.File(this.data.path);if(r.exists()===!1)return this.data.optional?this.resolve():(console.error("<config> Configuration file not found",this.data.path),this.reject());this.config=r.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=t(this.data.path,this.config));var i=this.data.getterProperty;return i&&(this.config=f(this.config,i)),d(this.config,n,a().params),this.resolve()},write:function(t){this.data.writable===!0&&(this.config=l(this.config,t),new e.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){i.register("files",r({Base:r.Deferred,Static:{canHandle:function(t){return Array.isArray(t.files)}},Construct:function(n){var e=t.file;return n.files.map(function(t){return new e({path:t})})},read:function(t){this.defer();var n=new e.File(this.data.path);if(n.exists()===!1)return this.data.optional?this.resolve():(console.error("<config> Configuration file not found",this.data.path),this.reject());this.config=n.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=module_eval(this.data.path,this.config));var r=this.data.getterProperty;return r&&(this.config=f(this.config,r)),d(this.config,t,a().params),this.resolve()},write:function(t){this.data.writable===!0&&(this.config=l(this.config,t),new e.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){i.register("directory",r({Base:r.Deferred,Static:{canHandle:function(t){var n=t.path;return"string"!=typeof n?!1:-1!==n.search(/[\*\?]/g)?!0:"/"===n[n.length-1]?!0:!1}},Construct:function(t){var n,r,o=t.path.replace(/\\/g,"/"),a=o.search(/[\*\?]/g),f=o.lastIndexOf("/",a);-1===a?n=o:(n=o.substring(0,f+1),r=o.substring(f+1));var s=new e.Directory(n).readFiles(r).files.map(function(t){return t.uri.toLocalFile()});return i.create([{files:s}]).toArray()}}))}(),function(){function t(t,n){return new(r({Base:r.Serializable,Store:r.MongoStore.Single(t),_id:n}))}i.register("mongo",r({Base:r.Deferred,Static:{canHandle:function(t){return"mongo"in t}},Construct:function(t){this.data=t,t.settings&&r.MongoStore.settings(t.settings),null==t.writable&&(t.writable=!0)},read:function(n){var e=n.mongodb;e&&r.MongoStore.settings(e);var i=this;return t(this.data.mongo).fetch().done(function(){i.config=this.toJSON(),i._id=this._id,delete i.config._id,i.resolve()}).fail(function(t){i.reject(t)}),i},write:function(t){this.config=l(this.config,t);var n=this;return r.MongoStore.resolveCollection(this.data.mongo).done(function(t){t.update({},n.config,{upsert:!0,multi:!1},function(t){return t?n.reject(t):(n.resolve(),void 0)})}),n}}))}(),function(){i.register("embedded",r({Base:r.Deferred,Static:{canHandle:function(t){return o(t.config)}},Construct:function(t){this.data=t,this.data.writable=!1,this.config=t.config},read:function(){this.resolve()}}))}(),function(){i.register("custom",r({Static:{canHandle:function(t){return"function"==typeof t}},Construct:function(t){return new t}}))}(),i}(),b=r({Base:r.Deferred,Construct:function(t){this.$data=t,this.$sources=y.create(t)},Static:{fetch:function(t){return new b(t).$read()},create:function(t){return new b(t)}},$get:function(t){return f(this,t)},$read:function(t){t=t||this.$data;var n=this;return this.defer(),this.$cli=a(),this.$sources.load(n).done(function(){var t,e=n.$cli.params;for(t in e)s(n,t,e[t]);h(n),n.resolve(n)}),n},$write:function(t){l(t);for(var n=this.$sources,e=n.length;--e>-1;)if(n[e].data.writable)return this.defer(),n[e].write(t),n[e].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return logger.error(r),this.reject(r)},$extend:function(t){l(this,t)},Override:{toJSON:function(){var t,n=this.super();for(t in n)"$"===t[0]&&delete n[t];return n}}});return n.Config=b});