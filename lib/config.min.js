/*!
 * config v0.1.12
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2014
 */
(function(t,n){"use strict";function e(){return n(i,r)}var r,i="undefined"==typeof window||null==window.navigator?global:window;return r=t||i,"function"==typeof define&&define.amd?define(e):(e(),"undefined"!=typeof module&&(module.exports=r.Config),void 0)})(this,function(t,n){"use strict";var e,r;(function(){r=t.atma&&t.atma.Class||t.Class||require("atma-libs/exports").Class,e=t.io||require("atma-io")})();var i,o;(function(){i=function(t){return null!=t&&"number"==typeof t.length&&"function"==typeof t.splice},o=function(t){return null!=t&&"object"==typeof t}})();var a;(function(){a=function(){for(var t,n,e,r=process.argv,i=r.length,o=2,a={},u=[];i>o;o++)e=r[o],"-"!==e[0]?u.push(e):(t=e.replace(/^[\-]+/,""),i-1>o&&"-"!==r[o+1][0]?(n=r[o+1],o++):n=!0,a[t]=n);return{params:a,args:u}}})();var u,f,c,s,l,g,d;(function(){u=function(t,n){for(var e=n.split("."),r=e.length,i=-1;r>++i;){if(null==t)return null;t=t[e[i]]}return t},f=function(t,n,e){for(var r,i=n.split("."),o=i.length,a=-1;o-1>++a;)r=i[a],null==t[r]&&(t[r]={}),t=t[r];t[i[a]]=e},c=function(t,n){for(var e in n)null==t[e]&&(t[e]=n[e]);return t},s=function(t,n){for(var e in n)null!=n[e]&&(t[e]=n[e]);return t},l=function(t,n){if(null==t&&(t={}),null==n)return t;if(i(t)&&i(n)){for(var e,r=0,a=n.length;a>r;r++)e=n[r],o(e)?t.push(l({},e)):t.push(e);return t}if(!o(n)&&!o(t))return logger.warn("<object:deepExtend> not an object or type missmatch - Dismiss"),t;var u,f;for(u in n)if(f=n[u],33!==u.charCodeAt(0))if(null!=t[u])if(i(f)){if(i(t[u])===!1){logger.warn("<object:deepExtend> type missmatch %s %s %s - Overwrite",u,f,t[u]),t[u]=f;continue}l(t[u],f)}else t[u]=o(f)&&o(t[u])?l(t[u],f):f;else t[u]=f;else t[u.substring(1)]=f;return t},g=function(t,n,e){var r=u(t,n);return null==r?f(t,n,null==e?{}:e):(typeof r!=typeof e&&logger.error("<obj_ensureProperty> type missmatch",typeof r,typeof e,Error().stack),void 0)},d=function(t,n){if(null!=t)if(null==n&&(n=t),i(t))for(var e=t.length;--e>-1;)d(t[e],n);else if(o(t)){var r,a;for(r in t)if(a=t[r],null!=a)if(o(a))d(a,n);else if("string"==typeof a){var f=a.trim();if("#["!==f.substring(0,2))continue;if(f=f.substring(2,f.length-1).trim(),t[r]=u(n,f),null==t[r]){console.warn("<config: obj_interpolate: property not exists in root",a);continue}}}}})();var h;(function(){function t(t){i(t)&&e(t),o(t)&&n(t)}function n(n){var e,i;for(e in n)i=n[e],o(i)!==!1&&(r(e)?f(e)&&l(n,i):a(i)?n[e]=s(i):t(i))}function e(n){for(var e,r,u=n.length,f=-1;u>++f;)if(e=n[f],o(e)!==!1)if(a(e)){if(r=s(e),null==r)continue;i(r)===!1&&(r=[r]),n.splice.apply(n,[f,1].concat(r)),f--,u+=r.length}else t(e)}function r(t){return 35!==t.charCodeAt(0)?!1:0===t.indexOf("#if ")}function a(t){for(var n in t)if(!r(n)&&n!==p)return!1;return!0}function f(t){var n=t.replace("#if ","").replace(/\b[\w\d_$]+\b/g,function(t){return'getter("'+t+'")'}),e=Function("getter","return !!("+n+")");try{return e(c)}catch(r){logger.error("<config:condition-object> Evalulation error",t,r)}return!1}function c(t){var n;return n=u(d,t),null!=n?n:(n=u(g,t),null!=n?n:null)}function s(t){for(var n in t)if(n!==p&&f(n))return t[n];return t[p]}var g,d,p="default";h=function(n,e,r){g=e,d=r,t(n)}})();var p,v;(function(){function t(t){var n=process.env,r=n[t];if(null!=r)return r;switch(t){case"TEMP":r=n.TMP||n.TMPDIR;break;case"APP":r=e.env.applicationDir.toLocalDir()}return null==r&&logger.error("<config:special-folder> Not resolved",t),v(r||n.HOME||t)}var n=/%([^%]+)%/g,r=/[\/]{2,}/g,i={};p=function(e){return n.test(e)===!1?e:v(e).replace(n,function(n,e){return e=e.toUpperCase(),null!=i[e]?i[e]:i[e]=t(e)}).replace(r,"/")},v=function(t){return t.replace(/\\/g,"/")}})();var w;(function(){w=function(t,n){if(null!=n.config){var e=n.data.setterProperty;e&&(g(config,e,{}),t=u(config,e)),l(t,n.config)}}})();var y=function(){var t={},n=r.Collection(Object,{Base:r.Deferred,add:function(t){return t.length&&"function"==typeof t.forEach?(t.forEach(function(t){this.push(t)},this),void 0):(this.push(t),void 0)},load:function(t,n){function e(t,n,e){return function(){w(e,n),t&&t(n,e)}}var i,o,a,u=this,f=u.length;null==n&&(n=-1);for(var c=0,s=new r.Await;f>++n;){if(i=u[n],++c>1&&i.data.sync){s.always(function(){u.load(t,n-1)});break}o=i.data&&i.data.beforeRead,a=i.data&&i.data.afterRead,o&&o(i,t),i.read(t),i.done(e(a,i,t)).always(s.delegate(null,!1))}return n>f-1&&s.always(u.resolveDelegate()),u}}),i={create:function(e){var r,i,o,a=e.length,u=-1,f=new n;t:for(;a>++u;){o=e[u];for(i in t)if(r=t[i],r.canHandle(o)){f.add(new r(o));continue t}logger.error("<unhandled configuration source> :",o)}return f},register:function(n,e){t[n]=e}};return function(){function t(t,n){var e={exports:{}},r=e.exports;try{Function("module","exports",n)(e,r)}catch(i){console.error("<config> Configuration evaluation error",t,i)}return 0===Object.keys(e.exports).length&&logger.error("<config> Define `module.exports = ` in a file to export configuration",t).log(" - (`global.config = ` support is removed)".yellow),e.exports}i.register("file",r({Base:r.Deferred,Static:{canHandle:function(t){var n=t.path;return"string"!=typeof n?!1:-1!==n.search(/\*\?/g)?!1:"/"===n[n.length-1]?!1:!0}},Construct:function(t){this.data=t,t.path=p(t.path)},read:function(n){this.defer();var r=new e.File(this.data.path);if(r.exists()===!1)return this.data.optional?this.resolve():(console.error("<config> Configuration file not found",this.data.path),this.reject());this.config=r.read(),"string"==typeof this.config&&(this.data.writable=!1,this.config=t(this.data.path,this.config));var i=this.data.getterProperty;return i&&(this.config=u(this.config,i)),h(this.config,n,a().params),this.resolve()},write:function(t){this.data.writable===!0&&(this.config=l(this.config,t),new e.File(this.data.path).write(this.config),this.resolve())}}))}(),function(){i.register("directory",r({Base:r.Deferred,Static:{canHandle:function(t){var n=t.path;return"string"!=typeof n?!1:-1!==n.search(/\*\?/g)?!0:"/"===n[n.length-1]?!0:!1}},Construct:function(t){var n,r,i=t.path.replace(/\\/g,"/"),o=i.search(/\*\?/g),a=i.lastIndexOf("/",o);return-1===o?n=i:(n=i.substring(0,a),r=i.substring(a+1)),new e.Directory(n).readFiles(r).files.map(function(t){return t.uri.toLocalFile()})}}))}(),function(){function t(t,n){return new(r({Base:r.Serializable,Store:r.MongoStore.Single(t),_id:n}))}i.register("mongo",r({Base:r.Deferred,Static:{canHandle:function(t){return"mongo"in t}},Construct:function(t){this.data=t,t.settings&&r.MongoStore.settings(t.settings),null==t.writable&&(t.writable=!0)},read:function(n){var e=n.mongodb;e&&r.MongoStore.settings(e);var i=this;return t(this.data.mongo).fetch().done(function(){i.config=this.toJSON(),i._id=this._id,delete i.config._id,i.resolve()}).fail(function(t){i.reject(t)}),i},write:function(t){this.config=l(this.config,t);var n=this;return r.MongoStore.resolveCollection(this.data.mongo).done(function(t){t.update({},n.config,{upsert:!0,multi:!1},function(t){return t?n.reject(t):(n.resolve(),void 0)})}),n}}))}(),function(){i.register("embedded",r({Base:r.Deferred,Static:{canHandle:function(t){return o(t.config)}},Construct:function(t){this.data=t,this.data.writable=!1,this.config=t.config},read:function(){this.resolve()}}))}(),function(){i.register("custom",r({Static:{canHandle:function(t){return"function"==typeof t}},Construct:function(t){return new t}}))}(),i}(),b=r({Base:r.Deferred,Construct:function(t){this.$data=t,this.$sources=y.create(t)},Static:{fetch:function(t){return new b(t).$read()},create:function(t){return new b(t)}},$get:function(t){return u(this,t)},$read:function(t){t=t||this.$data;var n=this;return this.defer(),this.$cli=a(),this.$sources.load(n).done(function(){var t,e=n.$cli.params;for(t in e)f(n,t,e[t]);d(n),n.resolve()}),n},$write:function(t){l(t);for(var n=this.$sources,e=n.length;--e>-1;)if(n[e].data.writable)return this.defer(),n[e].write(t),n[e].always(this.resolveDelegate()),this;var r="<config:write> Writable source not defined.";return logger.error(r),this.reject(r)},$extend:function(t){l(this,t)},Override:{toJSON:function(){var t,n=this.super();for(t in n)"$"===t[0]&&delete n[t];return n}}});return n.Config=b});